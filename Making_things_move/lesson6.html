


<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Lesson 6: Weight functions &#8212; AnyBody Tutorials v7.0.1 Documentation</title>
    <link rel="stylesheet" href="../_static/cloud.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noticia+Text|Open+Sans|Droid+Sans+Mono" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '7.0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../_static/jquery.cookie.js"></script>
    <script type="text/javascript" src="../_static/cloud.base.js"></script>
    <script type="text/javascript" src="../_static/cloud.js"></script>
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Lesson 7: Troubleshooting C3D files" href="lesson7.html" />
    <link rel="prev" title="Lesson 5: Using real data" href="lesson5.html" /> 
        <meta name="viewport" content="width=device-width, initial-scale=1">
  </head>
  <body>
    <div class="relbar-top">
        
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../contents.html" title="Table Of Contents"
             accesskey="C">toc</a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="lesson7.html" title="Lesson 7: Troubleshooting C3D files"
             accesskey="N">next</a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="lesson5.html" title="Lesson 5: Using real data"
             accesskey="P">previous</a> &nbsp; &nbsp;</li>
    <li><a href="../index.html">AnyBody Tutorials v7.0.1 Documentation</a> &#187;</li>

          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">Making things move</a> &#187;</li> 
      </ul>
    </div>
    </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="lesson-6-weight-functions">
<h1>Lesson 6: Weight functions<a class="headerlink" href="#lesson-6-weight-functions" title="Permalink to this headline">¶</a></h1>
<p>In this lesson, we shall learn how to use weight functions on kinematic
drivers. This is useful in over-determinate kinematic analysis where we
might want to let some drivers have more significance than others.
Without really discussing it, we used unity weights on all our soft
kinematic constraint equations in the previous lessons, but this is not
always the best choice as we shall see in this lesson.</p>
<p>So what are weight functions and what can they be used for? In general
the weights can be used to put more emphasis on some kinematic
constraint equations than on others. This will force the motion of the
model closer to the constraints with the higher weight. The two most
obvious places where these weight functions can be used are: 1) when you
trust one kinematic constraint more than another, e.g. if some markers
are more reliable than others. 2) If you have a marker temporarily
dropping out of sight of the cameras, then you can temporarily assign it
a weight of zero, which will eliminate it from the model in the interval
where it is invalid. There are of course many other possible uses of
weight functions, but we shall concentrate on markers in the following.</p>
<p>So without further ado, let us look into how to use a weight function to
deal with a marker dropping out. The data we are going to use is the
same pendulum example as used previously but with marker L002 modified
to drop out in the interval from 4.20 s to 4.76 s.</p>
<p>Please download and save the file
<a class="reference download internal" href="../_downloads/multiple_with_dropout.c3d" download=""><code class="xref download docutils literal"><span class="pre">multiple_with_dropout.c3d</span></code></a>.</p>
<p>Then close all open windows in AnyBody and create a new Main file by
clicking the ‘M’ tool button in the upper left hand corner of the main
frame. This creates an empty model into which you can insert an
AnyInputC3D object, refer to the <code class="docutils literal"><span class="pre">multiple_with_dropout.c3d</span></code> file and
specify the filter as we did before:</p>
<div class="highlight-AnyScriptDoc"><div class="highlight"><pre><span></span><span class="n">Main</span> <span class="o">=</span> <span class="p">{</span>
<span class="c1">// The actual body model goes in this folder</span>
<span class="kt">AnyFolder</span> <span class="n">MyModel</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1">// Global Reference Frame</span>
    <span class="kt">AnyFixedRefFrame</span> <span class="n">GlobalRef</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1">// Todo: Add points for grounding of the model here</span>
    <span class="p">};</span> <span class="c1">// Global reference frame</span>
    <span class="kt">AnyInputC3D</span> <span class="gr">C3D</span> <span class="o">=</span>
    <span class="p">{</span>
    <span class="n">FileName</span> <span class="o">=</span> <span class="s">&quot;§multiple_with_dropout.c3d§&quot;</span><span class="p">;</span>
    <span class="c1">//ReadAllDataOnOff = On;</span>
    <span class="c1">//TruncateExtraCharsInNamesOnOff = On;</span>
    <span class="c1">//MakeNameUniqueStr = &quot;_&quot;;</span>
    <span class="c1">//PointsScaleFactor = 1;</span>
    <span class="c1">//ConstructModelOnOff = On;</span>
    <span class="c1">//ConstructChartOnOff = On;</span>
    <span class="c1">//ConstructWeightFunUsingResidualOnOff = Off;</span>
    <span class="c1">//MarkerUseAllPointsOnOff = Off;</span>
    <span class="c1">//MarkerUseCamMaskOnOff = On;</span>
    <span class="c1">//MarkerIndices = {};</span>
    <span class="c1">//MarkerLabels = {};</span>
    <span class="c1">//MarkerFilterIndex = 0;</span>
    <span class="c1">//ProcessedDataFilterIndex = 0;</span>
    <span class="c1">//AnalogFilterIndex = -1;</span>
    <span class="gr">Filter =</span>
<span class="gr">    {</span>
<span class="gr">        AutomaticInitialConditionOnOff = On;</span>
<span class="gr">        FilterForwardBackwardOnOff = On;</span>
<span class="gr">        N = 2;</span>
<span class="gr">        Fc = {3};</span>
<span class="gr">        Type = LowPass;</span>
<span class="gr">    };</span>
    <span class="c1">//WeightThreshold = 0;</span>
    <span class="c1">//WeightOutput = {{0, 1}, {0, 1}, {0, 1}};</span>
    <span class="c1">//WeightTransitionTime = 0.1;</span>
    <span class="c1">//SearchAndReplace = {};</span>
    <span class="c1">//WriteMarkerDataToFilesOnOff = Off;</span>
    <span class="c1">//MarkerScaleXYZ = {0.025, 0.025, 0.025};</span>
    <span class="gr">MarkerRGB = {0, 0, 1};</span>
    <span class="c1">//MarkerDrawOnOff = On;</span>
    <span class="c1">//MarkerInterPolType = Bspline;</span>
    <span class="c1">//MarkerBsplineOrder = 8;</span>
<span class="p">};</span>
</pre></div>
</div>
<p>Notice that we have also colored the markers blue with the MarkerRGB
property. We also set the duration of the movement to automatically fit
the C3D file as we have done before:</p>
<div class="highlight-AnyScriptDoc"><div class="highlight"><pre><span></span><span class="c1">// The study: Operations to be performed on the model</span>
<span class="kt">AnyBodyStudy</span> <span class="n">MyStudy</span> <span class="o">=</span> <span class="p">{</span>
  <span class="kt">AnyFolder</span> <span class="o">&amp;</span><span class="n">Model</span> <span class="o">=</span> <span class="p">.</span><span class="n">MyModel</span><span class="p">;</span>
  <span class="n">Gravity</span> <span class="o">=</span> <span class="p">{</span><span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">9.81</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">};</span>
  <span class="gr">AnyIntVar FirstFrame = Main.MyModel.C3D.Header.FirstFrameNo;</span>
<span class="gr">  AnyIntVar LastFrame = Main.MyModel.C3D.Header.LastFrameNo;</span>
<span class="gr">  tStart = FirstFrame/Main.MyModel.C3D.Header.VideoFrameRate+2*Kinematics.ApproxVelAccPerturb;</span>
<span class="gr">  tEnd = LastFrame/Main.MyModel.C3D.Header.VideoFrameRate-2*Kinematics.ApproxVelAccPerturb;</span>
<span class="p">};</span>
</pre></div>
</div>
<p>Now you should be able to load and run the model and see three blue
markers travel through space in a motion that bears some resemblance to
a football kick as you did previously. However, notice how the L002
marker drops out. Many motion capture systems flag invalid markers in
the C3D file by setting the residual property to -1 for the affected
frames. If you click the Model tab, open MyModel, C3D, Points, Markers,
and L002, you will find the Residual property. If you double-click it
and scroll through it, you will see that there is an interval, where it
has the value -1.</p>
<p><a class="reference internal" href="../_images/image1.emf"><img alt="Marker residuals" src="../_images/image1.emf" style="width: 4.10486in; height: 3.51181in;" /></a></p>
<p>This information we are going to use later to construct a weight
function for this marker.</p>
<p>Let us initially define a segment with the three markers located on it,
ground it with a revolute joint and drive it using the marker data using
the AnyKinDriverMarker object as we did in lesson four:</p>
<div class="highlight-AnyScriptDoc"><div class="highlight"><pre><span></span><span class="gr">AnySeg Leg = {</span>
<span class="gr">  Mass = 1;</span>
<span class="gr">  Jii = {1, 0.01, 1}/15;</span>
<span class="gr">  AnyRefNode R1 = {</span>
<span class="gr">    sRel = {0.038, 0.18, 0.022};</span>
<span class="gr">  };</span>
<span class="gr">  AnyRefNode R2 = {</span>
<span class="gr">    sRel = {-0.015, -0.104, 0.028};</span>
<span class="gr">  };</span>
<span class="gr">  AnyRefNode R3 = {</span>
<span class="gr">    sRel = {-0.022, -0.403, -0.023};</span>
<span class="gr">  };</span>
<span class="gr">  AnyRefNode Joint = {</span>
<span class="gr">    sRel = {0, 0.45, 0};</span>
<span class="gr">  };</span>
<span class="gr">  AnyDrawSeg drw = {Opacity = 0.5;};</span>
<span class="gr">};</span>
<span class="gr">AnyRevoluteJoint Joint = {</span>
<span class="gr">  AnyRefFrame &amp;Ground = .GlobalRef;</span>
<span class="gr">  AnyRefFrame &amp;Pendulum = .Leg.Joint;</span>
<span class="gr">};</span>
<span class="gr">AnyKinDriverMarker C3Dmotion1 = {</span>
<span class="gr">  AnyRefFrame &amp;Marker = .Leg.R1;</span>
<span class="gr">  AnyParamFun &amp;Trajectory=</span>
<span class="gr">  Main.MyModel.C3D.Points.Markers.L000.PosInterpol;</span>
<span class="gr">  AnyDrawKinMeasure drw = {</span>
<span class="gr">    Label = Off;Size = 0.03;Line = Off;</span>
<span class="gr">  };</span>
<span class="gr">};</span>
<span class="gr">AnyKinDriverMarker C3Dmotion2 = {</span>
<span class="gr">  AnyRefFrame &amp;Marker = .Leg.R2;</span>
<span class="gr">  AnyParamFun &amp;Trajectory =</span>
<span class="gr">  Main.MyModel.C3D.Points.Markers.L001.PosInterpol;</span>
<span class="gr">  AnyDrawKinMeasure drw = {</span>
<span class="gr">    Label = Off;Size = 0.03;Line = Off;</span>
<span class="gr">  };</span>
<span class="gr">};</span>
<span class="gr">AnyKinDriverMarker C3Dmotion3 = {</span>
<span class="gr">  AnyRefFrame &amp;Marker = .Leg.R3;</span>
<span class="gr">  AnyParamFun &amp;Trajectory =</span>
<span class="gr">  Main.MyModel.C3D.Points.Markers.L002.PosInterpol;</span>
<span class="gr">  AnyDrawKinMeasure drw = {</span>
<span class="gr">    Label = Off;Size = 0.03;Line = Off;</span>
<span class="gr">  };</span>
<span class="gr">};</span>
<span class="p">};</span> <span class="c1">// MyModel</span>
</pre></div>
</div>
<p>Now that we want to drive a segment with the markers rather than just
look at the markers themselves, we also need to ask for the soft
kinematics solver in the study section:</p>
<div class="highlight-AnyScriptDoc"><div class="highlight"><pre><span></span><span class="c1">// The study: Operations to be performed on the model</span>
<span class="kt">AnyBodyStudy</span> <span class="n">MyStudy</span> <span class="o">=</span> <span class="p">{</span>
  <span class="kt">AnyFolder</span> <span class="o">&amp;</span><span class="n">Model</span> <span class="o">=</span> <span class="p">.</span><span class="n">MyModel</span><span class="p">;</span>
  <span class="n">Gravity</span> <span class="o">=</span> <span class="p">{</span><span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">9.81</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">};</span>
  <span class="kt">AnyIntVar</span> <span class="n">FirstFrame</span> <span class="o">=</span> <span class="n">Main</span><span class="p">.</span><span class="n">MyModel</span><span class="p">.</span><span class="n">C3D</span><span class="p">.</span><span class="n">Header</span><span class="p">.</span><span class="n">FirstFrameNo</span><span class="p">;</span>
  <span class="kt">AnyIntVar</span> <span class="n">LastFrame</span> <span class="o">=</span> <span class="n">Main</span><span class="p">.</span><span class="n">MyModel</span><span class="p">.</span><span class="n">C3D</span><span class="p">.</span><span class="n">Header</span><span class="p">.</span><span class="n">LastFrameNo</span><span class="p">;</span>
  <span class="n">tStart</span> <span class="o">=</span> <span class="n">FirstFrame</span><span class="o">/</span><span class="n">Main</span><span class="p">.</span><span class="n">MyModel</span><span class="p">.</span><span class="n">C3D</span><span class="p">.</span><span class="n">Header</span><span class="p">.</span><span class="n">VideoFrameRate</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">Kinematics</span><span class="p">.</span><span class="n">ApproxVelAccPerturb</span><span class="p">;</span>
  <span class="n">tEnd</span> <span class="o">=</span> <span class="n">LastFrame</span><span class="o">/</span><span class="n">Main</span><span class="p">.</span><span class="n">MyModel</span><span class="p">.</span><span class="n">C3D</span><span class="p">.</span><span class="n">Header</span><span class="p">.</span><span class="n">VideoFrameRate</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">Kinematics</span><span class="p">.</span><span class="n">ApproxVelAccPerturb</span><span class="p">;</span>
  <span class="gr">InitialConditions.SolverType = KinSolOverDeterminate;</span>
<span class="gr">  Kinematics.SolverType = KinSolOverDeterminate;</span>
<span class="p">};</span>
</pre></div>
</div>
<p>Please do not forget to change to the over-determinate kinematics
solver.</p>
<p>Now that we have created the AnyDrawKinMeasure objects, it is no longer
necessary to have the points drawn in the C3D object. So let us get rid
of them:</p>
<div class="highlight-AnyScriptDoc"><div class="highlight"><pre><span></span><span class="kt">AnyInputC3D</span> <span class="n">C3D</span> <span class="o">=</span>
<span class="p">{</span>
  <span class="n">FileName</span> <span class="o">=</span> <span class="s">&quot;multiple_with_dropout.c3d&quot;</span><span class="p">;</span>
  <span class="c1">//ReadAllDataOnOff = On;</span>
  <span class="c1">//TruncateExtraCharsInNamesOnOff = On;</span>
  <span class="c1">//MakeNameUniqueStr = &quot;_&quot;;</span>
  <span class="c1">//PointsScaleFactor = 1;</span>
  <span class="gr">ConstructModelOnOff = Off</span><span class="p">;</span>
  <span class="c1">//ConstructChartOnOff = On;</span>
  <span class="c1">//ConstructWeightFunUsingResidualOnOff = Off;</span>
  <span class="c1">//MarkerUseAllPointsOnOff = Off;</span>
  <span class="c1">//MarkerUseCamMaskOnOff = On;</span>
  <span class="c1">//MarkerIndices = {};</span>
  <span class="c1">//MarkerLabels = {};</span>
  <span class="c1">//MarkerFilterIndex = 0;</span>
  <span class="c1">//ProcessedDataFilterIndex = 0;</span>
  <span class="c1">//AnalogFilterIndex = -1;</span>
  <span class="n">Filter</span> <span class="o">=</span>
  <span class="p">{</span>
    <span class="n">AutomaticInitialConditionOnOff</span> <span class="o">=</span> <span class="kp">On</span><span class="p">;</span>
    <span class="n">FilterForwardBackwardOnOff</span> <span class="o">=</span> <span class="kp">On</span><span class="p">;</span>
    <span class="n">N</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="n">Fc</span> <span class="o">=</span> <span class="p">{</span><span class="mi">3</span><span class="p">};</span>
    <span class="n">Type</span> <span class="o">=</span> <span class="kp">LowPass</span><span class="p">;</span>
  <span class="p">};</span>
  <span class="c1">//WeightThreshold = 0;</span>
  <span class="c1">//WeightOutput = {{0, 1}, {0, 1}, {0, 1}};</span>
  <span class="c1">//WeightTransitionTime = 0.1;</span>
  <span class="c1">//SearchAndReplace = {};</span>
  <span class="c1">//WriteMarkerDataToFilesOnOff = Off;</span>
  <span class="c1">//MarkerScaleXYZ = {0.025, 0.025, 0.025};</span>
  <span class="n">MarkerRGB</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">};</span>
  <span class="c1">//MarkerDrawOnOff = On;</span>
  <span class="c1">//MarkerInterPolType = Bspline;</span>
  <span class="c1">//MarkerBsplineOrder = 8;</span>
<span class="p">};</span>
</pre></div>
</div>
<p>It should now be possible to load the model and run the kinematic
analysis. If you open the Model View, you should see something like
this:</p>
<p><a class="reference internal" href="../_images/image24.jpeg"><img alt="Model view, Pendulum" src="../_images/image24.jpeg" style="width: 2.93056in; height: 2.79097in;" /></a></p>
<p>You should see a large change in the otherwise smooth motion of the
pendulum, when marker L002 drops out, which it does by going to position
(0.0,-0.2,0.0). Since this configuration of the three markers is not
compatible with the rigid multi-body model with its imposed revolute
joint constraint, the result is that the pendulum is located somewhere
in between all three markers.</p>
<p>If you plot the acceleration of the segment, by opening a ChartFX and
going to MyStudy, Output, Model and Leg where you can find the rDDot
property.</p>
<p><a class="reference internal" href="../_images/image3.emf"><img alt="Chart view, rDDot" src="../_images/image3.emf" style="width: 4.81389in; height: 3.76736in;" /></a></p>
<p>This shows some large acceleration peaks of the segment when the marker
drops out.</p>
<p>So how can we deal with this problem? We can do this by using built-in
functionality in the C3D object to construct a weight function that is
zero in the interval where the marker is invalid and one otherwise,
except for a transition phase between the two. To do this, we have to
use the ConstructWeightFunUsingResidualOnOff setting in the C3D object.</p>
<div class="highlight-AnyScriptDoc"><div class="highlight"><pre><span></span><span class="kt">AnyInputC3D</span> <span class="n">C3D</span> <span class="o">=</span>
<span class="p">{</span>
  <span class="n">FileName</span> <span class="o">=</span> <span class="s">&quot;multiple_with_dropout.c3d&quot;</span><span class="p">;</span>
  <span class="c1">//ReadAllDataOnOff = On;</span>
  <span class="c1">//TruncateExtraCharsInNamesOnOff = On;</span>
  <span class="c1">//MakeNameUniqueStr = &quot;_&quot;;</span>
  <span class="c1">//PointsScaleFactor = 1;</span>
  <span class="n">ConstructModelOnOff</span> <span class="o">=</span> <span class="kp">Off</span><span class="p">;</span>
  <span class="c1">//ConstructChartOnOff = On;</span>
  <span class="gr">ConstructWeightFunUsingResidualOnOff = On</span><span class="p">;</span>
  <span class="c1">//MarkerUseAllPointsOnOff = Off;</span>
</pre></div>
</div>
<p>By default, this creates a weight function for each marker, which
assigns value one when the residual is positive and zero when it is
negative with a transition time between the two states of 0.1 s.</p>
<p>Now, all we have to do is link the weight function to the kinematic
constraint equation, where it should be used. In our model, this means
that we have to make the WeightFun member of the AnyKinDriverMarker
object for L002 point to the weight function for L002 in the C3D file.
The weight function is called Weight located in the same folder as the
PosInterpol.</p>
<div class="highlight-AnyScriptDoc"><div class="highlight"><pre><span></span><span class="kt">AnyKinDriverMarker</span> <span class="n">C3Dmotion3</span> <span class="o">=</span> <span class="p">{</span>
  <span class="gr">WeightFun = {&amp;Main.MyModel.C3D.Points.Markers.L002.Weight};</span>
  <span class="kt">AnyRefFrame</span> <span class="o">&amp;</span><span class="n">Marker</span> <span class="o">=</span> <span class="p">.</span><span class="n">Leg</span><span class="p">.</span><span class="n">R3</span><span class="p">;</span>
  <span class="kt">AnyParamFun</span> <span class="o">&amp;</span><span class="n">Trajectory</span> <span class="o">=</span>
  <span class="n">Main</span><span class="p">.</span><span class="n">MyModel</span><span class="p">.</span><span class="n">C3D</span><span class="p">.</span><span class="n">Points</span><span class="p">.</span><span class="n">Markers</span><span class="p">.</span><span class="n">L002</span><span class="p">.</span><span class="n">PosInterpol</span><span class="p">;</span>
  <span class="kt">AnyDrawKinMeasure</span> <span class="n">drw</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">Label</span> <span class="o">=</span> <span class="kp">Off</span><span class="p">;</span><span class="n">Size</span> <span class="o">=</span> <span class="mf">0.03</span><span class="p">;</span><span class="n">Line</span> <span class="o">=</span> <span class="kp">Off</span><span class="p">;</span>
  <span class="p">};</span>
</pre></div>
</div>
<p>If we reload and run the kinematic analysis again, we will see a much
more smooth motion, but if the acceleration is plotted again, then it is
clear that it is not perfect:</p>
<p><a class="reference internal" href="../_images/image4.emf"><img alt="Chart view, rDDot 2" src="../_images/image4.emf" style="width: 4.86042in; height: 3.75556in;" /></a></p>
<p>The graph looks similar to before, but the values on the ordinate axis
are much smaller. The remaining problem is related to the transition
time for switching the marker in and out. To investigate this in more
detail, we need graphs of the weight function as well as the trajectory
of the marker. Try including these lines in your model:</p>
<div class="highlight-AnyScriptDoc"><div class="highlight"><pre><span></span><span class="gr">AnyFloat EvalWeight = Main.MyModel.C3D.Points.Markers.L002.Weight(Main.MyStudy.t);</span>
<span class="gr">  AnyFloat EvalTrajectory = Main.MyModel.C3D.Points.Markers.L002.PosInterpol(Main.MyStudy.t); </span>
  <span class="kt">AnyInputC3D</span> <span class="n">C3D</span> <span class="o">=</span>
</pre></div>
</div>
<p>What this code does is that it evaluates the Weight and PosInterpol
parameter functions at all time steps in the analysis. Hereby, we can
plot them both after a kinematic analysis. Try reloading the model,
re-running the kinematic analysis, and then plot each of these two
functions by browsing to them using two separate ChartFX windows. You
should now be able to see something like this:</p>
<p><a class="reference internal" href="../_images/image5.emf"><img alt="Chart view, weight function" src="../_images/image5.emf" style="width: 4.68611in; height: 2.41875in;" /></a><a class="reference internal" href="../_images/image6.emf"><img alt="Chart view, filtered marker positions" src="../_images/image6.emf" style="width: 4.68611in; height: 2.41875in;" /></a></p>
<p>What has happened is that the filtering and the interpolation of the
marker trajectory have smoothed the drop out transition and even
introduced small peaks before and after the marker data really disappear
as given by the Residual. Therefore, we need to make the period, in
which the marker is assigned low weight, longer. To do this, we simply
extend the transition period a bit using the WeightTransitionTime in the
C3D object:</p>
<div class="highlight-AnyScriptDoc"><div class="highlight"><pre><span></span><span class="kt">AnyInputC3D</span> <span class="n">C3D</span> <span class="o">=</span>
<span class="p">{</span>
  <span class="n">FileName</span> <span class="o">=</span> <span class="s">&quot;multiple_with_dropout.c3d&quot;</span><span class="p">;</span>
  <span class="c1">//ReadAllDataOnOff = On;</span>
  <span class="c1">//TruncateExtraCharsInNamesOnOff = On;</span>
  <span class="c1">//MakeNameUniqueStr = &quot;_&quot;;</span>
  <span class="c1">//PointsScaleFactor = 1;</span>
  <span class="n">ConstructModelOnOff</span> <span class="o">=</span> <span class="kp">Off</span><span class="p">;</span>
  <span class="c1">//ConstructChartOnOff = On;</span>
  <span class="n">ConstructWeightFunUsingResidualOnOff</span> <span class="o">=</span> <span class="kp">On</span><span class="p">;</span>
  <span class="c1">//MarkerUseAllPointsOnOff = Off;</span>
  <span class="c1">//MarkerUseCamMaskOnOff = On;</span>
  <span class="c1">//MarkerIndices = {};</span>
  <span class="c1">//MarkerLabels = {};</span>
  <span class="c1">//MarkerFilterIndex = 0;</span>
  <span class="c1">//ProcessedDataFilterIndex = 0;</span>
  <span class="c1">//AnalogFilterIndex = -1;</span>
  <span class="n">Filter</span> <span class="o">=</span>
  <span class="p">{</span>
    <span class="n">AutomaticInitialConditionOnOff</span> <span class="o">=</span> <span class="kp">On</span><span class="p">;</span>
    <span class="n">FilterForwardBackwardOnOff</span> <span class="o">=</span> <span class="kp">On</span><span class="p">;</span>
    <span class="n">N</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="n">Fc</span> <span class="o">=</span> <span class="p">{</span><span class="mi">3</span><span class="p">};</span>
    <span class="n">Type</span> <span class="o">=</span> <span class="kp">LowPass</span><span class="p">;</span>
  <span class="p">};</span>
  <span class="c1">//WeightThreshold = 0;</span>
  <span class="c1">//WeightOutput = {{0, 1}, {0, 1}, {0, 1}};</span>
  <span class="gr">WeightTransitionTime = 0.8;</span>
  <span class="c1">//SearchAndReplace = {};</span>
  <span class="c1">//WriteMarkerDataToFilesOnOff = Off;</span>
  <span class="c1">//MarkerScaleXYZ = {0.025, 0.025, 0.025};</span>
  <span class="n">MarkerRGB</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">};</span>
  <span class="c1">//MarkerDrawOnOff = On;</span>
  <span class="c1">//MarkerInterPolType = Bspline;</span>
  <span class="c1">//MarkerBsplineOrder = 8;</span>
<span class="p">};</span>
</pre></div>
</div>
<p>If we reload and run the kinematic analysis, we should now see the
pendulum moving smoothly and it is almost impossible to detect in the
motion that the marker disappears. If we plot the segment acceleration
again, we see that we no longer have any of the peaks around the drop
out of the marker:</p>
<p><a class="reference internal" href="../_images/image7.emf"><img alt="Chart view rDDot final" src="../_images/image7.emf" style="width: 4.91875in; height: 3.94167in;" /></a></p>
<p>Hopefully, this simple example has demonstrated how the weight functions
works. In fact, the WeightFun members of the AnyKinMarkerDriver class
come from the parent class AnyKinEq such that all kinematic constraint
equations can be assigned a weight; not only markers. Also, WeightFun is
a pointer to a ParamFun, which means that all AnyScript parameter
functions can be used as weights. In other words, you can design your
own weight function using any of the parametric function types in the
system.</p>
<p>The final lesson of this tutorial is about problems that may arise with
C3D files.</p>
<div class="without-title admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last"><strong>Next lesson:</strong> <a class="reference internal" href="lesson7.html"><span class="doc">Lesson 7: Troubleshooting C3D files</span></a>.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
        <p class="logo"><a href="../index.html" title="index">
          <img class="logo" src="../_static/anybody_tutorials_logo.png" alt="Logo"/>
        </a></p>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
<div class="sphinx-toc sphinxglobaltoc">
<h3><a href="../contents.html">Table Of Contents</a></h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../index.html">Tutorial overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../A_Getting_started/index.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../A_Getting_started_anyscript/index.html">Getting started: AnyScript Programming</a></li>
<li class="toctree-l1"><a class="reference internal" href="../A_Getting_started_modeling/index.html">Getting Started with Modeling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Interface_features/index.html">User interface features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../A_study_of_studies/index.html">A Study of Studies</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Making things move</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="intro.html">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="lesson1.html">Lesson1: Simple drivers</a></li>
<li class="toctree-l2"><a class="reference internal" href="lesson2.html">Lesson 2: Using motion capture data</a></li>
<li class="toctree-l2"><a class="reference internal" href="lesson3.html">Lesson3: Noise and filters</a></li>
<li class="toctree-l2"><a class="reference internal" href="lesson4.html">Lesson 4: Parameter identification</a></li>
<li class="toctree-l2"><a class="reference internal" href="lesson5.html">Lesson 5: Using real data</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Lesson 6: Weight functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="lesson7.html">Lesson 7: Troubleshooting C3D files</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../MuscleRecruitment/index.html">Inverse Dynamics of Muscle Systems</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ForceDependentKinematics/index.html">Force-Dependent Kinematics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Muscle_modeling/index.html">Muscle Modeling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../The_mechanical_elements/index.html">The Mechanical Elements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Advanced_script_features/index.html">Advanced Script Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Finite_element_analysis/index.html">Finite Element Analysis Interfacing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../AnyExp4SOLIDWORKS/index.html">Making Models using SOLIDWORKS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Scaling/index.html">Scaling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Validation_of_models/index.html">Validation of Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Parameter_studies_and_optimization/index.html">Parameter Studies and Optimization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Troubleshooting_anyscript/intro.html">Trouble Shooting AnyScript Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Posture_and_movement/intro.html">Posture and Movement Prediction</a></li>
</ul>
</div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/Making_things_move/lesson6.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
        </div>
      </div>
    
    
        <div class="sidebar-toggle-group no-js">
            
            <button class="sidebar-toggle" id="sidebar-hide" title="Hide the sidebar menu">
                 «
                <span class="show-for-small">hide menu</span>
                
            </button>
            <button class="sidebar-toggle" id="sidebar-show" title="Show the sidebar menu">
                
                <span class="show-for-small">menu</span>
                <span class="hide-for-small">sidebar</span>
                 »
            </button>
        </div>
    
      <div class="clearer"></div>
    </div>
    <div class="relbar-bottom">
        
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../contents.html" title="Table Of Contents"
             >toc</a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="lesson7.html" title="Lesson 7: Troubleshooting C3D files"
             >next</a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="lesson5.html" title="Lesson 5: Using real data"
             >previous</a> &nbsp; &nbsp;</li>
    <li><a href="../index.html">AnyBody Tutorials v7.0.1 Documentation</a> &#187;</li>

          <li class="nav-item nav-item-1"><a href="index.html" >Making things move</a> &#187;</li> 
      </ul>
    </div>
    </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2017, AnyBody Technology.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.6.5.
    </div>
    <!-- cloud_sptheme 1.4 -->
  </body>
</html>