


<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Lesson 2: Using motion capture data &#8212; AnyBody Tutorials v7.3.0</title>
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/cloud.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css" />
    <link rel="stylesheet" type="text/css" href="../_static/table_styling.css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noticia+Text|Open+Sans|Droid+Sans+Mono" type="text/css" />
    
    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>

    
    
     
        <script src="../_static/jquery.cookie.js"></script>
    

    
     
        <script src="../_static/cloud.base.js"></script>
    

    
     
        <script src="../_static/cloud.js"></script>
    

    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Lesson3: Noise and filters" href="lesson3.html" />
    <link rel="prev" title="Lesson1: Simple drivers" href="lesson1.html" /> 
        <meta name="viewport" content="width=device-width, initial-scale=1">
  </head><body>
    <div class="relbar-top">
        
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../contents.html" title="Table Of Contents"
             accesskey="C">toc</a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="lesson3.html" title="Lesson3: Noise and filters"
             accesskey="N">next</a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="lesson1.html" title="Lesson1: Simple drivers"
             accesskey="P">previous</a> &nbsp; &nbsp;</li>
    <li><a href="../index.html">AnyBody Tutorials v7.3.0</a> &#187;</li>

          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U"><span class="section-number">7. </span>Making things move</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Lesson 2: Using motion capture data</a></li> 
      </ul>
    </div>
    </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="lesson-2-using-motion-capture-data">
<h1>Lesson 2: Using motion capture data<a class="headerlink" href="#lesson-2-using-motion-capture-data" title="Permalink to this headline">¶</a></h1>
<p>In biomechanics, we often want to make our models move as we have measured in
the laboratory and the measurement technique would often be tracking of optical
markers in space by means of synchronized cameras.</p>
<p>There are many such systems available commercially, but a common feature of most
of the systems is that they are capable of saving data on a standard format
called a C3D file.</p>
<p>A C3D file contains data of the spatial trajectory of optical markers fixed to
the object whose motion we want to record. The file can also contain analog data
such as force platform measurements or EMG.</p>
<p>AnyBody can read the data from a C3D file directly. Please download and save the
file <a class="reference download internal" download="" href="../_downloads/4b05076c724e287b6bb4ab73db12ff1c/pendulum.c3d"><code class="xref download docutils literal notranslate"><span class="pre">pendulum.c3d</span></code></a> in the directory where
you saved the <code class="file docutils literal notranslate"><span class="pre">Pendulum.any</span></code> file.</p>
<p>Next, place the cursor in the editor window just before the <code class="code docutils literal notranslate"><span class="pre">AnyKinMotion</span></code>
object, click the Classes tab (on the right side of the screen), unfold the class list, and locate the
<code class="code docutils literal notranslate"><span class="pre">AnyInputC3D</span></code> class. Right-click the class and choose “Insert Class
Template”.</p>
<div class="highlight-AnyScriptDoc notranslate"><div class="highlight"><pre><span></span><span class="kt">AnyInputC3D</span> <span class="o">&lt;</span><span class="n">ObjectName</span><span class="o">&gt;</span> <span class="o">=</span>
<span class="p">{</span>
<span class="n">FileName</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
<span class="c1">//ReadAllDataOnOff = On;</span>
<span class="c1">//TruncateExtraCharsInNamesOnOff = On;</span>
<span class="c1">//MakeNameUniqueStr = &quot;_&quot;;</span>
<span class="c1">//PointsScaleFactor = 1.0;</span>
<span class="c1">//ConstructModelOnOff = On;</span>
<span class="c1">//ConstructChartOnOff = On;</span>
<span class="c1">//ConstructWeightFunUsingResidualOnOff = Off;</span>
<span class="c1">//GapFillUsingResidualsOnOff = Off;</span>
<span class="c1">//MarkerUseAllPointsOnOff = Off;</span>
<span class="c1">//MarkerUseCamMaskOnOff = On;</span>
<span class="c1">//MarkerIndices = ;</span>
<span class="c1">//MarkerLabels = ;</span>
<span class="c1">//MarkerFilterIndex = 0;</span>
<span class="c1">//ProcessedDataFilterIndex = 0;</span>
<span class="c1">//AnalogFilterIndex = -1;</span>
<span class="cm">/*Filter =</span>
<span class="cm">{</span>
<span class="cm">z0 = ;</span>
<span class="cm">AutomaticInitialConditionOnOff = On;</span>
<span class="cm">FilterForwardBackwardOnOff = On;</span>
<span class="cm">N = 2;</span>
<span class="cm">W = ;</span>
<span class="cm">Fs = 0.0;</span>
<span class="cm">Fc = {10.0};</span>
<span class="cm">Type = LowPass;</span>
<span class="cm">};*/</span>
<span class="c1">//WeightThreshold = 0.0;</span>
<span class="c1">//WeightOutput = {{0.0, 1.0}, {0.0, 1.0}, {0.0, 1.0}};</span>
<span class="c1">//WeightTransitionTime = 0.1;</span>
<span class="c1">//SearchAndReplace = ;</span>
<span class="c1">//WriteMarkerDataToFilesOnOff = Off;</span>
<span class="c1">//MarkerScaleXYZ = {0.025, 0.025, 0.025};</span>
<span class="c1">//MarkerRGB = {0.65, 0.65, 0.65};</span>
<span class="c1">//MarkerDrawOnOff = On;</span>
<span class="c1">//MarkerInterPolType = Bspline;</span>
<span class="c1">//MarkerBsplineOrder = 4;</span>
<span class="p">};</span>
</pre></div>
</div>
<p>As you can see, the class has a lot of settings, but for now we shall
only use two of them, namely FileName and ConstructChartOnOff. We also
give a name to the object:</p>
<div class="highlight-AnyScriptDoc notranslate"><div class="highlight"><pre><span></span><span class="kt">AnyInputC3D</span> <span class="gr">C3D</span> <span class="o">=</span> <span class="p">{</span>
  <span class="n">FileName</span> <span class="o">=</span><span class="gr"> &quot;pendulum.c3d&quot;;</span>
  <span class="c1">//TruncateExtraCharsInNamesOnOff = On;</span>
  <span class="c1">//MakeNameUniqueStr = &quot;_&quot;;</span>
  <span class="c1">//PointsScaleFactor = 1;</span>
  <span class="c1">//ConstructModelOnOff = On;</span>
  <span class="gr">ConstructChartOnOff = Off;</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">ConstructChartOnOff</span></code> instructs the C3D object to not draw 3D
trajectories.</p>
<p>Now, try loading the model again. You may get the following error
message:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Time, &#39;t&#39;, has an invalid value for this interpolation
</pre></div>
</div>
<p>C3D files contain marker trajectories covering a certain time span and
what goes on outside that interval is undefined. Furthermore, the very
beginning and very end of that time span may not be useful for the
motion interpolation due to initial transients.</p>
<p>If you have a C3D file of unknown duration, then you somehow have to figure out
its start and end times to enable AnyBody to analyze it. A simple way to do this
is to allow AnyBody to load the file by temporarily disabling the study section
of your model. This will eliminate the study’s conflicting start and end times.
Just block-select the study section and click the “Comment out” tool button over
the editor window (or press <code class="docutils literal notranslate"><span class="pre">Ctrl+Shift+k</span></code>):</p>
<div class="highlight-AnyScriptDoc notranslate"><div class="highlight"><pre><span></span><span class="c1">// The study: Operations to be performed on the model</span>
<span class="gr">//</span><span class="c1">  AnyBodyStudy MyStudy = {</span>
<span class="gr">//</span><span class="c1">    AnyFolder &amp;Model = .MyModel;</span>
<span class="gr">//</span><span class="c1">    Gravity = {0.0, -9.81, 0.0};</span>
<span class="gr">//</span><span class="c1">  };</span>
</pre></div>
</div>
<p>Now the model should load with no problems, and you can go to the tree
view in the left hand side of the screen, click the Model tab and unfold
the MyModel tree down to the C3D object as shown below.</p>
<p><img alt="Model tree" src="../_images/image128.png" /></p>
<p>A bit down in this object you find the Header section. When you unfold
it you get access to a number of basic properties of the C3D file. Each
time you double-click a property, a window will pop up and give you its
value. The important properties in question are these:</p>
<div class="highlight-AnyScriptDoc notranslate"><div class="highlight"><pre><span></span><span class="n">FirstFrameNo</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">LastFrameNo</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="n">VideoFrameRate</span> <span class="o">=</span> <span class="mi">100</span>
</pre></div>
</div>
<p>This shows that the file has a total of 1000 frames at 100 frames/sec,
i.e. the simulation time spans ten seconds. We can now go to the editor
window and remove the temporary double slashes in front of each line in
the study section.</p>
<div class="highlight-AnyScriptDoc notranslate"><div class="highlight"><pre><span></span><span class="c1">// The study: Operations to be performed on the model</span>
<span class="gr">AnyBodyStudy MyStudy = {</span>
<span class="gr">    AnyFolder &amp;Model = .MyModel;</span>
<span class="gr">    Gravity = {0.0, -9.81, 0.0};</span>
<span class="gr">};</span>
</pre></div>
</div>
<p>…and insert specifications of simulation time:</p>
<div class="highlight-AnyScriptDoc notranslate"><div class="highlight"><pre><span></span><span class="kt">AnyBodyStudy</span> <span class="n">MyStudy</span> <span class="o">=</span> <span class="p">{</span>
    <span class="kt">AnyFolder</span> <span class="o">&amp;</span><span class="n">Model</span> <span class="o">=</span> <span class="p">.</span><span class="n">MyModel</span><span class="p">;</span>
    <span class="n">Gravity</span> <span class="o">=</span> <span class="p">{</span><span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">9.81</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">};</span>
    <span class="gr">tStart = 0.05;</span>
<span class="gr">    tEnd = 9.95;</span>
<span class="p">};</span>
</pre></div>
</div>
<p>There is also an automated way to handle the problem. The frame rate
variables we have just processed manually can also be referred to
directly in the study section, such that the tStart and tEnd parameters
automatically adapt to the C3D file. Try this instead:</p>
<div class="highlight-AnyScriptDoc notranslate"><div class="highlight"><pre><span></span><span class="kt">AnyBodyStudy</span> <span class="n">MyStudy</span> <span class="o">=</span> <span class="p">{</span>
  <span class="kt">AnyFolder</span> <span class="o">&amp;</span><span class="n">Model</span> <span class="o">=</span> <span class="p">.</span><span class="n">MyModel</span><span class="p">;</span>
  <span class="n">Gravity</span> <span class="o">=</span> <span class="p">{</span><span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">9.81</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">};</span>
  <span class="gr">AnyIntVar FirstFrame = Main.MyModel.C3D.Header.FirstFrameNo;</span>
<span class="gr">  AnyIntVar LastFrame = Main.MyModel.C3D.Header.LastFrameNo;</span>
<span class="gr">  tStart = FirstFrame/Main.MyModel.C3D.Header.VideoFrameRate+2*Kinematics.ApproxVelAccPerturb;</span>
<span class="gr">  tEnd = LastFrame/Main.MyModel.C3D.Header.VideoFrameRate-2*Kinematics.ApproxVelAccPerturb;</span>
<span class="p">};</span>
</pre></div>
</div>
<p>Notice that we start the simulation <code class="docutils literal notranslate"><span class="pre">2*Kinematics.ApproxVelAccPerturb</span></code>
after the beginning of the recorded motion and we end it similarly
before the end of the recording. The variable
<code class="docutils literal notranslate"><span class="pre">Kinematics.ApproxVelAccPerturb</span></code> contains information about the
algorithm’s necessary elbow room on each side of the analyzed interval.
This eliminates possible numerical trouble with end points.</p>
<p>Now the model should load and the Model View window will display a small, grey
dot to the right of the pendulum end.</p>
<p><img alt="small dot" src="../_images/image22.jpeg" /></p>
<p>The small dot is in fact the single marker contained in <code class="file docutils literal notranslate"><span class="pre">Pendulum.c3d</span></code>. A
typical file from a real motion capture experiment can contain dozens of
markers, but in the interest of simplicity we have just included a single one
here. The <code class="docutils literal notranslate"><span class="pre">AnyInputC3D</span></code> object automatically creates the small dots and the
drivers necessary to move them around as they were recorded. If you run the
Kinematics operation, you will see the pendulum move as before, while the marker
performs an oscillating motion back and forth</p>
<p>So how do we get the marker to drive the pendulum? This can be done
quite easily with the AnyKinDriverMarker object. The steps are:</p>
<ol class="arabic simple">
<li><p>Remove the existing driver that makes the pendulum rotate.</p></li>
<li><p>Drive the marker point, <code class="docutils literal notranslate"><span class="pre">P1</span></code>, on the pendulum to follow the data
recorded in the C3D file.</p></li>
</ol>
<p>Start by selecting the existing <code class="docutils literal notranslate"><span class="pre">AnyKinMotion</span></code> driver and comment it out
of the model. That takes care of step 1.</p>
<p>Then click the Classes tab on the right side of the screen,
insert a new <code class="docutils literal notranslate"><span class="pre">AnyKinDriverMarker</span></code> template, and give it a name:</p>
<div class="highlight-AnyScriptDoc notranslate"><div class="highlight"><pre><span></span><span class="gr">AnyKinDriverMarker &lt;ObjectName&gt; =</span>
<span class="gr">{</span>
<span class="gr">  //RefFrames = ;</span>
<span class="gr">  //Surfaces = ;</span>
<span class="gr">  //KinMeasureArr = ;</span>
<span class="gr">  //KinMeasureIndexArr = ;</span>
<span class="gr">  //MeasureOrganizer = ;</span>
<span class="gr">  //CType = ;</span>
<span class="gr">  //WeightFun = ;</span>
<span class="gr">  //DriverPos0 = ;</span>
<span class="gr">  //DriverVel0 = ;</span>
<span class="gr">  //DriverAcc0 = ;</span>
<span class="gr">  AnyRefFrame &amp;&lt;Insert name0&gt; = &lt;Insert object reference (or full object definition)&gt;;</span>
<span class="gr">  //AnyRefFrame &amp;&lt;Insert name1&gt; = &lt;Insert object reference (or full object definition)&gt;;</span>
<span class="gr">  //AnyParamFun &amp;&lt;Insert name0&gt; = &lt;Insert object reference (or full object definition)&gt;;</span>
<span class="gr">};</span>
</pre></div>
</div>
<p>Just as before, the <code class="docutils literal notranslate"><span class="pre">AnyKinDriverMarker</span></code> object needs to know what to
drive and what to drive it with. The “what to drive” part is the
position of <code class="docutils literal notranslate"><span class="pre">P1</span></code> on the pendulum. This is specified with the first
reference frame in the object:</p>
<div class="highlight-AnyScriptDoc notranslate"><div class="highlight"><pre><span></span><span class="kt">AnyKinDriverMarker</span> <span class="gr">C3DMotion</span> <span class="o">=</span>
<span class="p">{</span>
  <span class="c1">//RefFrames = ;</span>
  <span class="c1">//Surfaces = ;</span>
  <span class="c1">//KinMeasureArr = ;</span>
  <span class="c1">//KinMeasureIndexArr = ;</span>
  <span class="c1">//MeasureOrganizer = ;</span>
  <span class="c1">//CType = ;</span>
  <span class="c1">//WeightFun = ;</span>
  <span class="c1">//DriverPos0 = ;</span>
  <span class="c1">//DriverVel0 = ;</span>
  <span class="c1">//DriverAcc0 = ;</span>
  <span class="gr">AnyRefFrame &amp;Marker = .Pendulum.P1;</span>
  <span class="c1">//AnyRefFrame &amp;&lt;Insert name1&gt; = &lt;Insert object reference (or full object definition)&gt;;</span>
  <span class="c1">//AnyParamFun &amp;&lt;Insert name0&gt; = &lt;Insert object reference (or full object definition)&gt;;</span>
<span class="p">};</span>
</pre></div>
</div>
<p>The marker coordinates in the C3D file are recorded in the laboratory
coordinate system, which we shall assume is our global reference frame.
Driving from <code class="docutils literal notranslate"><span class="pre">GlobalRef</span></code> is default in linear measures, so we need not
mention <code class="docutils literal notranslate"><span class="pre">GlobalRef</span></code> explicitly in the <code class="docutils literal notranslate"><span class="pre">AnyKinDriverMarker</span></code> object.</p>
<p>We are going to drive the point directly by means of the interpolation
function specifying the marker trajectory in the C3D object. First, give
a reasonable name to the <code class="docutils literal notranslate"><span class="pre">AnyParamFun</span></code> and remove the stuff after the
equality sign:</p>
<div class="highlight-AnyScriptDoc notranslate"><div class="highlight"><pre><span></span><span class="kt">AnyKinDriverMarker</span> <span class="n">C3DMotion</span> <span class="o">=</span>
<span class="p">{</span>
  <span class="c1">//RefFrames = ;</span>
  <span class="c1">//Surfaces = ;</span>
  <span class="c1">//KinMeasureArr = ;</span>
  <span class="c1">//KinMeasureIndexArr = ;</span>
  <span class="c1">//MeasureOrganizer = ;</span>
  <span class="c1">//CType = ;</span>
  <span class="c1">//WeightFun = ;</span>
  <span class="c1">//DriverPos0 = ;</span>
  <span class="c1">//DriverVel0 = ;</span>
  <span class="c1">//DriverAcc0 = ;</span>
  <span class="kt">AnyRefFrame</span> <span class="o">&amp;</span><span class="n">Marker</span> <span class="o">=</span> <span class="p">.</span><span class="n">Pendulum</span><span class="p">.</span><span class="n">P1</span><span class="p">;</span>
  <span class="c1">//AnyRefFrame &amp;&lt;Insert name1&gt; = &lt;Insert object reference (or full object definition)&gt;;</span>
  <span class="kt">AnyParamFun</span> <span class="gr">&amp;Trajectory = ;</span>
<span class="p">};</span>
</pre></div>
</div>
<p>Then click the Model tab in the tree view on the left hand side of the editor
window, unfold the MyModel branch and subsequently the <code class="docutils literal notranslate"><span class="pre">C3D</span></code> object -&gt;
<code class="docutils literal notranslate"><span class="pre">Points</span></code> -&gt; <code class="docutils literal notranslate"><span class="pre">Markers</span></code> -&gt; <code class="docutils literal notranslate"><span class="pre">L000</span></code> and arrive at <code class="docutils literal notranslate"><span class="pre">PosInterpol</span></code> as shown
below.</p>
<p><img alt="Model tree 2" src="../_images/image320.png" /></p>
<p>This is the actual interpolation function of the marker in question.
Place the cursor after the equality sign of the <code class="docutils literal notranslate"><span class="pre">AnyParamFun</span></code> line,
right-click the PosInterpol object, and choose “Insert object name”. You
should get this:</p>
<div class="highlight-AnyScriptDoc notranslate"><div class="highlight"><pre><span></span><span class="kt">AnyKinDriverMarker</span> <span class="n">C3DMotion</span> <span class="o">=</span>
<span class="p">{</span>
  <span class="c1">//RefFrames = ;</span>
  <span class="c1">//Surfaces = ;</span>
  <span class="c1">//KinMeasureArr = ;</span>
  <span class="c1">//KinMeasureIndexArr = ;</span>
  <span class="c1">//MeasureOrganizer = ;</span>
  <span class="c1">//CType = ;</span>
  <span class="c1">//WeightFun = ;</span>
  <span class="c1">//DriverPos0 = ;</span>
  <span class="c1">//DriverVel0 = ;</span>
  <span class="c1">//DriverAcc0 = ;</span>
  <span class="kt">AnyRefFrame</span> <span class="o">&amp;</span><span class="n">Marker</span> <span class="o">=</span> <span class="p">.</span><span class="n">Pendulum</span><span class="p">.</span><span class="n">P1</span><span class="p">;</span>
  <span class="c1">//AnyRefFrame &amp;&lt;Insert name1&gt; = &lt;Insert object reference (or full object definition)&gt;;</span>
  <span class="kt">AnyParamFun</span> <span class="o">&amp;</span><span class="n">Trajectory</span> <span class="o">=</span> <span class="gr">Main.MyModel.C3D.Points.Markers.L000.PosInterpol</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<p>Now load the model and run the kinematic analysis. You will get the
following error message:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>ERROR(OBJ.MCH.KIN3) :  ... Kinematic analysis failed in time step 0 : System is kinematically over-constrained
</pre></div>
</div>
<p>It is time to think back to the concept of degrees-of-freedom, DoF. In the
beginning of the tutorial, we established that the free pendulum has one DoF.
But the marker trajectory has three coordinates and therefore wants to drive
<code class="docutils literal notranslate"><span class="pre">P1</span></code> of the pendulum in <span class="math notranslate nohighlight">\(x\)</span>, <span class="math notranslate nohighlight">\(y\)</span> and <span class="math notranslate nohighlight">\(z\)</span>, i.e. two DoFs more
than we have available.</p>
<p>There are two possible solutions to this problem. Either we pick only one of the
directions given by the marker and let the revolute joint decide the rest, or we
have to accept that the pendulum cannot follow the marker completely in all
three DoFs, i.e. something has to give.</p>
<p>Driving just one direction would be fairly simple in this case, but in a
more complicated model with many markers, the selection of a subset of
directions to drive can be a very tedious process.</p>
<p>Another aspect to
consider is that marker data are measured and therefore always infested
with various types of errors and noise. One of the serious errors in
motion capture technology is the so-called soft tissue artifact or skin
artifact. It comes from the fact that markers are placed on the skin at
some distance from the bone whose motion they are supposed to record.
Between the marker and the bone are layers of skin, fat and muscle, so
the marker never moves exactly with the bone. It is therefore natural in
the model to presume that the connection between the marker and the bone
is not a rigid one, and when that is the case, AnyBody will accept
drivers on more DoFs than the model actually has.</p>
<p>Resolving the kinematics in the presence of moving markers is somewhat
more complicated numerically, so we have to ask for a specific
kinematics solver that can handle it. This is done in the study section:</p>
<div class="highlight-AnyScriptDoc notranslate"><div class="highlight"><pre><span></span><span class="kt">AnyBodyStudy</span> <span class="n">MyStudy</span> <span class="o">=</span> <span class="p">{</span>
  <span class="kt">AnyFolder</span> <span class="o">&amp;</span><span class="n">Model</span> <span class="o">=</span> <span class="p">.</span><span class="n">MyModel</span><span class="p">;</span>
  <span class="n">Gravity</span> <span class="o">=</span> <span class="p">{</span><span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">9.81</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">};</span>
  <span class="kt">AnyIntVar</span> <span class="n">FirstFrame</span> <span class="o">=</span> <span class="n">Main</span><span class="p">.</span><span class="n">MyModel</span><span class="p">.</span><span class="n">C3D</span><span class="p">.</span><span class="n">Header</span><span class="p">.</span><span class="n">FirstFrameNo</span><span class="p">;</span>
  <span class="kt">AnyIntVar</span> <span class="n">LastFrame</span> <span class="o">=</span> <span class="n">Main</span><span class="p">.</span><span class="n">MyModel</span><span class="p">.</span><span class="n">C3D</span><span class="p">.</span><span class="n">Header</span><span class="p">.</span><span class="n">LastFrameNo</span><span class="p">;</span>
  <span class="n">tStart</span> <span class="o">=</span><span class="n">FirstFrame</span><span class="o">/</span><span class="n">Main</span><span class="p">.</span><span class="n">MyModel</span><span class="p">.</span><span class="n">C3D</span><span class="p">.</span><span class="n">Header</span><span class="p">.</span><span class="n">VideoFrameRate</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">Kinematics</span><span class="p">.</span><span class="n">ApproxVelAccPerturb</span><span class="p">;</span>
  <span class="n">tEnd</span> <span class="o">=</span> <span class="n">LastFrame</span><span class="o">/</span><span class="n">Main</span><span class="p">.</span><span class="n">MyModel</span><span class="p">.</span><span class="n">C3D</span><span class="p">.</span><span class="n">Header</span><span class="p">.</span><span class="n">VideoFrameRate</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">Kinematics</span><span class="p">.</span><span class="n">ApproxVelAccPerturb</span><span class="p">;</span>
  <span class="gr">InitialConditions.SolverType = KinSolOverDeterminate;</span>
<span class="gr">  Kinematics.SolverType = KinSolOverDeterminate;</span>

<span class="p">};</span>
</pre></div>
</div>
<p>The two additional lines select a kinematic solver for the
InitialConditions and Kinematics operations that will accept more
kinematic constraints than the system has DoFs.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>See <a class="reference external" href="http://www.tandfonline.com/doi/abs/10.1080/10255840802459412">Andersen MS, Damsgaard M, and Rasmussen J. 2007</a>
for detailed information about the algorithm behind the overdeterminate kinematic analysis.</p>
</div>
<p>Now you can reload and run the kinematic analysis and you should see the
pendulum following the marker movement. You cannot see the marker during the
movement because it is hidden inside the pendulum. In fact, the marker is not
strictly necessary for the analysis and we can get rid of it altogether by an
additional specification in the C3D object:</p>
<div class="highlight-AnyScriptDoc notranslate"><div class="highlight"><pre><span></span><span class="kt">AnyInputC3D</span> <span class="n">C3D</span> <span class="o">=</span>
<span class="p">{</span>
  <span class="n">FileName</span> <span class="o">=</span> <span class="s">&quot;pendulum.c3d&quot;</span><span class="p">;</span>
  <span class="c1">//ReadAllDataOnOff = On;</span>
  <span class="c1">//TruncateExtraCharsInNamesOnOff = On;</span>
  <span class="c1">//MakeNameUniqueStr = &quot;_&quot;;</span>
  <span class="c1">//PointsScaleFactor = 1.0;</span>
  <span class="gr">ConstructModelOnOff = Off;</span>
  <span class="n">ConstructChartOnOff</span> <span class="o">=</span> <span class="kp">Off</span><span class="p">;</span>
  <span class="c1">//ConstructWeightFunUsingResidualOnOff = Off;</span>
  <span class="c1">//GapFillUsingResidualsOnOff = Off;</span>
  <span class="c1">//MarkerUseAllPointsOnOff = Off;</span>
  <span class="c1">//MarkerUseCamMaskOnOff = On;</span>
  <span class="p">...</span>
</pre></div>
</div>
<p>With the unnecessary marker gone from the model, the kinematic analysis
runs much faster than before. Each marker adds DoFs and constraints to
the model, and they require solution time. It is therefore more
efficient to leave the markers out unless you really need them.</p>
<p>Now that there is driver between pendulum and the marker, it is possible
to simultaneously draw both the point on the pendulum and the marker
from the C3D file. To do this, start by placing the cursor inside the
AnyKinDriverMarker object.</p>
<p>Then click the Classes tab on the right side of screen, insert a new
<code class="docutils literal notranslate"><span class="pre">AnyDrawKinMeasure</span></code> template, remove the properties we will not need and give
it a name:</p>
<div class="highlight-AnyScriptDoc notranslate"><div class="highlight"><pre><span></span><span class="kt">AnyKinDriverMarker</span> <span class="n">C3Dmotion</span> <span class="o">=</span>
<span class="p">{</span>
  <span class="c1">//MeasureOrganizer = {};</span>
  <span class="c1">//CType = ;</span>
  <span class="c1">//WeightFun = {};</span>
  <span class="c1">//DriverPos0 = {};</span>
  <span class="c1">//DriverVel0 = {};</span>
  <span class="c1">//DriverAcc0 = {};</span>
  <span class="kt">AnyRefFrame</span> <span class="o">&amp;</span><span class="n">Marker</span> <span class="o">=</span> <span class="p">.</span><span class="n">Pendulum</span><span class="p">.</span><span class="n">P1</span><span class="p">;</span>
  <span class="c1">//AnyRefFrame &amp;&lt;Insert name1&gt; = &lt;Insert object reference (or full object definition)&gt;;</span>
  <span class="kt">AnyParamFun</span> <span class="o">&amp;</span><span class="n">Trajectory</span> <span class="o">=</span>
  <span class="n">Main</span><span class="p">.</span><span class="n">MyModel</span><span class="p">.</span><span class="n">C3D</span><span class="p">.</span><span class="n">Points</span><span class="p">.</span><span class="n">Markers</span><span class="p">.</span><span class="n">L000</span><span class="p">.</span><span class="n">PosInterpol</span><span class="p">;</span>

  <span class="gr">AnyDrawKinMeasure drw =</span>
<span class="gr">  {</span>
<span class="gr">    //Label = On;</span>
<span class="gr">    //Size = 0.02;</span>
<span class="gr">    //Line = On;</span>
<span class="gr">  };</span>
<span class="p">};</span>
</pre></div>
</div>
<p>If you reload the model, you should see something like this:</p>
<p><img alt="Model view AnyKinDriver marker" src="../_images/image42.jpeg" /></p>
<p>The blue dot illustrates the marker from the c3d file and the red line
is drawn to illustrate the difference between the point on the segment
and the measured point. Please notice that there is a small ball hidden
inside yellow sphere from the drawing of the segment. The plot also
shows a label “KDM”, which indicates that it is an <code class="docutils literal notranslate"><span class="pre">AnyKinDriverMarker</span></code>
that is drawn.</p>
<p>The line between the two points and the label can be removed by changing
the <code class="docutils literal notranslate"><span class="pre">Label</span></code> and <code class="docutils literal notranslate"><span class="pre">Line</span></code> settings to Off. Let us also change the size of the
dots such that we can see both the point on the segment as well as the
measured point.</p>
<div class="highlight-AnyScriptDoc notranslate"><div class="highlight"><pre><span></span><span class="kt">AnyDrawKinMeasure</span> <span class="n">drw</span> <span class="o">=</span>
<span class="p">{</span>
  <span class="gr">Label = Off;</span>
<span class="gr">  Size = 0.07;</span>
<span class="gr">  Line = Off;</span>
<span class="p">};</span>
</pre></div>
</div>
<p>Reloading the model should show you something like this:</p>
<p><img alt="Model view DrawKinMeasure" src="../_images/image52.jpeg" /></p>
<p>Let us briefly investigate the kinematic constraints of our model. Click
the Model tab in the tree view on the left hand side of the screen and
unfold the <code class="docutils literal notranslate"><span class="pre">Joint</span></code> branch. Inside you find <code class="docutils literal notranslate"><span class="pre">Constraints</span></code>, and after
unfolding that branch you find the property <code class="docutils literal notranslate"><span class="pre">CType</span></code>. If you double-click
it, the popup window shows the following:</p>
<div class="highlight-AnyScriptDoc notranslate"><div class="highlight"><pre><span></span><span class="n">CType</span> <span class="o">=</span> <span class="p">{</span><span class="kp">Hard</span><span class="p">,</span> <span class="kp">Hard</span><span class="p">,</span> <span class="kp">Hard</span><span class="p">,</span> <span class="kp">Hard</span><span class="p">,</span> <span class="kp">Hard</span><span class="p">}</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">CType</span></code> appears to be a vector with five components, owing to the fact
that a revolute joint has five constraints, and CType specifies that all
of these are <code class="docutils literal notranslate"><span class="pre">Hard</span></code>. This means that the kinematic solver is not allowed
to violate any of them.</p>
<p>If you similarly locate and unfold the <code class="docutils literal notranslate"><span class="pre">C3DMotion</span></code> object you again find a
<code class="docutils literal notranslate"><span class="pre">CType</span></code>, and double-clicking it reveals</p>
<div class="highlight-AnyScriptDoc notranslate"><div class="highlight"><pre><span></span><span class="n">CType</span> <span class="o">=</span> <span class="p">{</span><span class="kp">Soft</span><span class="p">,</span> <span class="kp">Soft</span><span class="p">,</span> <span class="kp">Soft</span><span class="p">}</span>
</pre></div>
</div>
<p>We have implicitly specified that the joint is a hard constraint while
the marker is a soft constraint. Joints automatically have their
constraint types set to Hard and <code class="docutils literal notranslate"><span class="pre">AnyKinDriverMarker</span></code> objects
automatically have soft constraints, but these rules can be overridden
by the user by explicit specification of <code class="docutils literal notranslate"><span class="pre">CType</span></code> in the respective
objects.</p>
<p>In <a class="reference internal" href="lesson3.html"><span class="doc">Lesson 3</span></a> we investigate how to filter noise out of
the measured data.</p>
<div class="without-title admonition seealso">
<p class="admonition-title">See also</p>
<p><strong>Next lesson:</strong> <a class="reference internal" href="lesson3.html"><span class="doc">Lesson3: Noise and filters</span></a>.</p>
</div>
</div>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
        <p class="logo"><a href="../index.html" title="index">
          <img class="logo" src="../_static/anybody_tutorials_logo.png" alt="Logo"/>
        </a></p>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
<div class="sphinx-toc sphinxglobaltoc">
<h3><a href="../contents.html">Table of Contents</a></h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../index.html">Tutorial overview</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../A_Getting_started/index.html">1. Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../A_Getting_started_anyscript/index.html">2. Getting started: AnyScript Programming</a></li>
<li class="toctree-l1"><a class="reference internal" href="../A_Getting_started_modeling/index.html">3. Getting Started with Modeling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../A_Getting_started_AMMR/index.html">4. Getting started: The Model Repository</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Interface_features/index.html">5. User interface features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../A_study_of_studies/index.html">6. A Study of Studies</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">7. Making things move</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="intro.html">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="lesson1.html">Lesson1: Simple drivers</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Lesson 2: Using motion capture data</a></li>
<li class="toctree-l2"><a class="reference internal" href="lesson3.html">Lesson3: Noise and filters</a></li>
<li class="toctree-l2"><a class="reference internal" href="lesson4.html">Lesson 4: Parameter identification</a></li>
<li class="toctree-l2"><a class="reference internal" href="lesson5.html">Lesson 5: Using real data</a></li>
<li class="toctree-l2"><a class="reference internal" href="lesson6.html">Lesson 6: Troubleshooting C3D files</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../MuscleRecruitment/index.html">8. Inverse Dynamics of Muscle Systems</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ForceDependentKinematics/index.html">9. Force-Dependent Kinematics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Muscle_modeling/index.html">10. Muscle Modeling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../The_mechanical_elements/index.html">11. The Mechanical Elements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Advanced_script_features/index.html">12. Advanced Script Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Finite_element_analysis/index.html">13. Finite Element Analysis Interfacing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../AnyExp4SOLIDWORKS/index.html">14. Making Models using SOLIDWORKS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Scaling/index.html">15. Personalizing Your Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Validation_of_models/index.html">16. Validation of Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Parameter_studies_and_optimization/index.html">17. Parameter Studies and Optimization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Troubleshooting_anyscript/intro.html">18. Trouble Shooting AnyScript Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Posture_and_movement/intro.html">19. Posture and Movement Prediction</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../legal.html">Legal, Trademarks and Copyrights</a></li>
</ul>
</div><h3>Found a problem?</h3>

<p><a href="https://github.com/AnyBody/anybody-tutorial/blob/master/Making_things_move/lesson2.rst">
    <img src="../_static/mark-github.svg"></img> Fix it your self </a> or <a href="https://github.com/AnyBody/anybody-tutorial/issues/">report it </a>
</p>
        </div>
      </div>
    
    
        <div class="sidebar-toggle-group no-js">
            
            <button class="sidebar-toggle" id="sidebar-hide" title="Hide the sidebar menu">
                 «
                <span class="show-for-small">hide menu</span>
                
            </button>
            <button class="sidebar-toggle" id="sidebar-show" title="Show the sidebar menu">
                
                <span class="show-for-small">menu</span>
                <span class="hide-for-small">sidebar</span>
                 »
            </button>
        </div>
    
      <div class="clearer"></div>
    </div>
    <div class="relbar-bottom">
        
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../contents.html" title="Table Of Contents"
             >toc</a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="lesson3.html" title="Lesson3: Noise and filters"
             >next</a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="lesson1.html" title="Lesson1: Simple drivers"
             >previous</a> &nbsp; &nbsp;</li>
    <li><a href="../index.html">AnyBody Tutorials v7.3.0</a> &#187;</li>

          <li class="nav-item nav-item-1"><a href="index.html" ><span class="section-number">7. </span>Making things move</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Lesson 2: Using motion capture data</a></li> 
      </ul>
    </div>
    </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2021, AnyBody Technology.
    </div>
    <!-- cloud_sptheme 1.4 -->
  </body>
</html>