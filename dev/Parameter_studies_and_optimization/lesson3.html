


<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><meta content="noindex" name="robots" />

    <title>Optimization Studies in Python &#8212; AnyBody Tutorials v7.1.2-dev</title>
    <link rel="stylesheet" href="../_static/cloud.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noticia+Text|Open+Sans|Droid+Sans+Mono" type="text/css" />
    <script type="text/javascript" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../_static/jquery.cookie.js"></script>
    <script type="text/javascript" src="../_static/cloud.base.js"></script>
    <script type="text/javascript" src="../_static/cloud.js"></script>
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="18. Trouble Shooting AnyScript Models" href="../Troubleshooting_anyscript/intro.html" />
    <link rel="prev" title="Optimization Studies" href="lesson2.html" /> 
        <meta name="viewport" content="width=device-width, initial-scale=1">
  </head><body>
    <div class="relbar-top">
        
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../contents.html" title="Table Of Contents"
             accesskey="C">toc</a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="../Troubleshooting_anyscript/intro.html" title="18. Trouble Shooting AnyScript Models"
             accesskey="N">next</a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="lesson2.html" title="Optimization Studies"
             accesskey="P">previous</a> &nbsp; &nbsp;</li>
    <li><a href="../index.html">AnyBody Tutorials v7.1.2-dev</a> &#187;</li>

          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">17. Parameter Studies and Optimization</a> &#187;</li> 
      </ul>
    </div>
    </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="optimization-studies-in-python">
<h1>Optimization Studies in Python<a class="headerlink" href="#optimization-studies-in-python" title="Permalink to this headline">¶</a></h1>
<p>The optimization study introduces in the preceding lesson used AnyBody’s builtin
facilities for optimizing. Sometimes that is not enough, either because the
objective functions depends on data that is not easily included in AnyBody, or
because a different solver is needed.</p>
<p>In this tutorial we use an external optimizer together with AnyBody. The example is
based on the model from the <a class="reference internal" href="lesson2.html"><span class="doc">previous lesson</span></a> but uses an optimizer
in the Python programming language. But the same could be achived with other
tools like MatLab etc.</p>
<div class="section" id="requirements">
<h2>Requirements<a class="headerlink" href="#requirements" title="Permalink to this headline">¶</a></h2>
<p>Before we begin you need to install the Anaconda Python distribution. It is free and comes
with most of the necessary packages preinstalled.</p>
<ul class="simple">
<li>Download and install Anaconda Python Distribution (&gt;3.6)</li>
</ul>
<p>We also need one additional Python library (<a class="reference external" href="https://anybody-research-group.github.io/anypytools-docs/">AnyPyTools</a>) which will make
it easier to work with AnyBody from Python.</p>
<p>AnyPyTools can be easily installed from the command prompt. Open the Anaconda
command prompt and type:</p>
<div class="highlight-bat notranslate"><div class="highlight"><pre><span></span>conda config --add channels conda-forge
conda install anypytools
</pre></div>
</div>
</div>
<div class="section" id="running-a-model-from-python">
<h2>Running a model from Python<a class="headerlink" href="#running-a-model-from-python" title="Permalink to this headline">¶</a></h2>
<p>If you didn’t complete the model from <a class="reference internal" href="lesson2.html"><span class="doc">lesson 2</span></a>, you can download the
<a class="reference download internal" href="../_downloads/OptimBike2-lesson3.zip" download=""><code class="xref download docutils literal"><span class="pre">finshed model here</span></code></a>.</p>
<p>For the external optimizers to work, we need a way to run AnyBody models from
Python and record the results of the simulations. There are more information on
how to do this in the <a class="reference external" href="https://anybody-research-group.github.io/anypytools-docs/">documentaion for AnyPyTools</a>. So here we will
just show how the code looks and not discuss the details.</p>
<p>First we create a new Python file <code class="docutils literal highlight highlight-AnyScriptDoc"><span></span><span class="n">optimize</span><span class="p">.</span><span class="n">py</span></code> and place next to our main file <code class="docutils literal highlight highlight-AnyScriptDoc"><span></span><span class="n">BikeModel2D</span><span class="p">.</span><span class="n">main</span><span class="p">.</span><span class="n">any</span></code>.
Within the file we create a Python function to run the AnyBody simulation.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">scipy</span>

<span class="kn">from</span> <span class="nn">anypytools</span> <span class="kn">import</span> <span class="n">AnyPyProcess</span>
<span class="kn">from</span> <span class="nn">anypytools.macro_commands</span> <span class="kn">import</span> <span class="n">Load</span><span class="p">,</span> <span class="n">OperationRun</span><span class="p">,</span> <span class="n">Dump</span><span class="p">,</span> <span class="n">SetValue</span>

<span class="k">def</span> <span class="nf">run_model</span><span class="p">(</span><span class="n">saddle_height</span><span class="p">,</span> <span class="n">saddle_pos</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
   <span class="sd">&quot;&quot;&quot;Run the AnyBody model and return the metabolism results&quot;&quot;&quot;</span>
   <span class="n">macro</span> <span class="o">=</span> <span class="p">[</span>
       <span class="n">Load</span><span class="p">(</span><span class="s2">&quot;BikeModel2D.main.any&quot;</span><span class="p">),</span>
       <span class="n">SetValue</span><span class="p">(</span><span class="s2">&quot;Main.BikeParameters.SaddleHeight&quot;</span><span class="p">,</span> <span class="n">saddle_height</span><span class="p">),</span>
       <span class="n">SetValue</span><span class="p">(</span><span class="s2">&quot;Main.BikeParameters.SaddlePos&quot;</span><span class="p">,</span> <span class="n">saddle_pos</span><span class="p">),</span>
       <span class="n">OperationRun</span><span class="p">(</span><span class="s2">&quot;Main.Study.InverseDynamics&quot;</span><span class="p">),</span>
       <span class="n">Dump</span><span class="p">(</span><span class="s2">&quot;Main.Study.Output.Pmet&quot;</span><span class="p">),</span>
       <span class="n">Dump</span><span class="p">(</span><span class="s2">&quot;Main.Study.Output.Abscissa.t&quot;</span><span class="p">),</span>
   <span class="p">]</span>
   <span class="n">app</span> <span class="o">=</span> <span class="n">AnyPyProcess</span><span class="p">(</span><span class="n">silent</span><span class="o">=</span><span class="n">silent</span><span class="p">)</span>
   <span class="n">results</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">start_macro</span><span class="p">(</span><span class="n">macro</span><span class="p">)</span>
   <span class="k">return</span> <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">run_model</span><span class="p">(</span><span class="mf">0.66</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.16</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;Main.Study.Output.Pmet&quot;</span><span class="p">])</span>
</pre></div>
</div>
<p>The functions <code class="docutils literal highlight highlight-AnyScriptDoc"><span></span><span class="n">run_model</span><span class="p">()</span></code> takes <code class="docutils literal highlight highlight-AnyScriptDoc"><span></span><span class="n">saddle_height</span></code> and <code class="docutils literal highlight highlight-AnyScriptDoc"><span></span><span class="n">saddle_pos</span></code> as input and return
the <code class="docutils literal highlight highlight-AnyScriptDoc"><span></span><span class="n">Pmet</span></code> metabolism output.</p>
<p>The two last lines are just for testing. They call the function and prints the result.
Let us test it by running the python file:</p>
<div class="highlight-bat notranslate"><div class="highlight"><pre><span></span>python optimize.py
[****************100<span class="nv">%*</span>*****************]  1 of 1 completeTotal time: 0.6 seconds
[  17.20903341   73.49291834  209.58490241  379.67002659  559.57715608
736.92126247  901.88875426 1045.75303378 1162.65470516 1248.32088806
1299.79539032 1315.38241529 1294.6947524  1238.68684947 1149.59584772
1030.78784505  886.60667952  722.43408728  547.1840971   368.64175002
198.07134668   53.41928909   25.84379129   30.60376508   23.17442367
24.30809055  139.3209062   292.35610808  469.73382854  649.02576552
821.74094457  977.02863522 1108.05435136 1209.79739513 1278.65973442
1312.31195028 1309.70451022 1271.1212895  1198.17227557 1093.68215448
961.51890402  806.51623776  634.74029158  458.00117565  280.40563034
121.30841553   21.54859903   28.97200722   26.82989147   17.2090334 ]
</pre></div>
</div>
</div>
<div class="section" id="defining-the-objective-function">
<h2>Defining the objective function<a class="headerlink" href="#defining-the-objective-function" title="Permalink to this headline">¶</a></h2>
<p>The next step is to define the objective function. The objective function should
take an array of design values as input and return the objective function value.
In <a class="reference internal" href="lesson2.html"><span class="doc">Lesson 2</span></a> the objective function was the time integral of the
metabolism variable. So we will do the same:</p>
<p>So remove the last two lines and add a new function like this.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">objfun</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">saddle_height</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">saddle_pos</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">run_model</span><span class="p">(</span><span class="n">saddle_height</span><span class="p">,</span> <span class="n">saddle_pos</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;ERROR&quot;</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Failed to run model&quot;</span><span class="p">)</span>

    <span class="c1"># Integrate Pmet</span>
    <span class="n">pmet</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">integrate</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;Pmet&quot;</span><span class="p">],</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;Abscissa.t&quot;</span><span class="p">])</span>

    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">pmet</span><span class="p">)</span>

<span class="n">pmet</span> <span class="o">=</span> <span class="n">objfun</span><span class="p">([</span><span class="mf">0.66</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.16</span><span class="p">])</span>
<span class="k">print</span><span class="p">(</span><span class="n">pmet</span><span class="p">)</span>
</pre></div>
</div>
<p>Now let us try running the file again:</p>
<div class="highlight-bat notranslate"><div class="highlight"><pre><span></span>$ python optimize.py
505.329399532772
</pre></div>
</div>
</div>
<div class="section" id="setting-up-the-optimization-study">
<h2>Setting up the optimization study<a class="headerlink" href="#setting-up-the-optimization-study" title="Permalink to this headline">¶</a></h2>
<p>Finally, we wrap things up by calling the <code class="docutils literal highlight highlight-AnyScriptDoc"><span></span><span class="n">scipy</span><span class="p">.</span><span class="n">optimize</span><span class="p">.</span><span class="n">minimize</span></code>….</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">seat_distance_constraint</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Compute contraint value which must be larger than zero&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.66</span><span class="p">)</span>

<span class="n">constaints</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;ineq&quot;</span><span class="p">,</span> <span class="s2">&quot;fun&quot;</span><span class="p">:</span> <span class="n">seat_distance_constraint</span><span class="p">}</span>
<span class="n">bounds</span> <span class="o">=</span> <span class="p">[(</span><span class="mf">0.65</span><span class="p">,</span> <span class="mf">0.73</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mf">0.22</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.05</span><span class="p">)]</span>
<span class="n">initial_guess</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.7</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.15</span><span class="p">)</span>

<span class="n">solution</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">optimize</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span>
    <span class="n">objfun</span><span class="p">,</span> <span class="n">initial_guess</span><span class="p">,</span> <span class="n">constraints</span><span class="o">=</span><span class="n">constaints</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;SLSQP&quot;</span>
<span class="p">)</span>


<span class="k">print</span><span class="p">(</span><span class="n">solution</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
        <p class="logo"><a href="../index.html" title="index">
          <img class="logo" src="../_static/anybody_tutorials_logo.png" alt="Logo"/>
        </a></p>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
<div class="sphinx-toc sphinxglobaltoc">
<h3><a href="../contents.html">Table Of Contents</a></h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../index.html">Tutorial overview</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../A_Getting_started/index.html">1. Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../A_Getting_started_anyscript/index.html">2. Getting started: AnyScript Programming</a></li>
<li class="toctree-l1"><a class="reference internal" href="../A_Getting_started_modeling/index.html">3. Getting Started with Modeling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../A_Getting_started_AMMR/index.html">4. Getting started: The Model Repository</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Interface_features/index.html">5. User interface features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../A_study_of_studies/index.html">6. A Study of Studies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Making_things_move/index.html">7. Making things move</a></li>
<li class="toctree-l1"><a class="reference internal" href="../MuscleRecruitment/index.html">8. Inverse Dynamics of Muscle Systems</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ForceDependentKinematics/index.html">9. Force-Dependent Kinematics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Muscle_modeling/index.html">10. Muscle Modeling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../The_mechanical_elements/index.html">11. The Mechanical Elements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Advanced_script_features/index.html">12. Advanced Script Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Finite_element_analysis/index.html">13. Finite Element Analysis Interfacing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../AnyExp4SOLIDWORKS/index.html">14. Making Models using SOLIDWORKS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Scaling/index.html">15. Personalizing Your Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Validation_of_models/index.html">16. Validation of Models</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">17. Parameter Studies and Optimization</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="intro.html">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="lesson1.html">Defining a Parameter Study</a></li>
<li class="toctree-l2"><a class="reference internal" href="lesson2.html">Optimization Studies</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Optimization Studies in Python</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../Troubleshooting_anyscript/intro.html">18. Trouble Shooting AnyScript Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Posture_and_movement/intro.html">19. Posture and Movement Prediction</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../legal.html">Legal, Trademarks and Copyrights</a></li>
</ul>
</div><h3>Tutorials not working?</h3>
<p><a href="https://github.com/AnyBody/anybody-tutorial/issues/"><img src="_static/mark-github.svg"></img> Please report it here...</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/Parameter_studies_and_optimization/lesson3.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
        </div>
      </div>
    
    
        <div class="sidebar-toggle-group no-js">
            
            <button class="sidebar-toggle" id="sidebar-hide" title="Hide the sidebar menu">
                 «
                <span class="show-for-small">hide menu</span>
                
            </button>
            <button class="sidebar-toggle" id="sidebar-show" title="Show the sidebar menu">
                
                <span class="show-for-small">menu</span>
                <span class="hide-for-small">sidebar</span>
                 »
            </button>
        </div>
    
      <div class="clearer"></div>
    </div>
    <div class="relbar-bottom">
        
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../contents.html" title="Table Of Contents"
             >toc</a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="../Troubleshooting_anyscript/intro.html" title="18. Trouble Shooting AnyScript Models"
             >next</a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="lesson2.html" title="Optimization Studies"
             >previous</a> &nbsp; &nbsp;</li>
    <li><a href="../index.html">AnyBody Tutorials v7.1.2-dev</a> &#187;</li>

          <li class="nav-item nav-item-1"><a href="index.html" >17. Parameter Studies and Optimization</a> &#187;</li> 
      </ul>
    </div>
    </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2018, AnyBody Technology.
    </div>
    <!-- cloud_sptheme 1.4 -->
  </body>
</html>