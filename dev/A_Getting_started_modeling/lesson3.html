


<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><meta content="noindex" name="robots" />

    <title>Lesson 3: Making Ends Meet &#8212; AnyBody Tutorials v7.2.0-dev</title>
    <link rel="stylesheet" href="../_static/cloud.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Noticia+Text|Open+Sans|Droid+Sans+Mono" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/language_data.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../_static/jquery.cookie.js"></script>
    <script type="text/javascript" src="../_static/cloud.base.js"></script>
    <script type="text/javascript" src="../_static/cloud.js"></script>
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Lesson 4: Kinetics - Computing Forces" href="lesson4.html" />
    <link rel="prev" title="Lesson 2: Adjusting the Human Model" href="lesson2.html" /> 
        <meta name="viewport" content="width=device-width, initial-scale=1">
  </head><body>
    <div class="relbar-top">
        
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../contents.html" title="Table Of Contents"
             accesskey="C">toc</a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="lesson4.html" title="Lesson 4: Kinetics - Computing Forces"
             accesskey="N">next</a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="lesson2.html" title="Lesson 2: Adjusting the Human Model"
             accesskey="P">previous</a> &nbsp; &nbsp;</li>
    <li><a href="../index.html">AnyBody Tutorials v7.2.0-dev</a> &#187;</li>

          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">3. Getting Started with Modeling</a> &#187;</li> 
      </ul>
    </div>
    </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="lesson-3-making-ends-meet">
<h1>Lesson 3: Making Ends Meet<a class="headerlink" href="#lesson-3-making-ends-meet" title="Permalink to this headline">¶</a></h1>
<p>Your model still lacks the the full specifications of how the human and
environment (pedal &amp; ground) are connected, and how the model moves.</p>
<p>To ensure that sufficient kinematic information is provided to AnyBody, it is best to start with
an inventory check on the degrees of freedom (DOFs) of the model.</p>
<div class="section" id="degrees-of-freedom-overview">
<h2>Degrees of freedom overview<a class="headerlink" href="#degrees-of-freedom-overview" title="Permalink to this headline">¶</a></h2>
<p>The pedal is simply hinged to the global reference frame, and has the following DOFs:</p>
<ul class="simple">
<li>1 DOF of rotation at the hinge.</li>
</ul>
<p>With no environmental constraints defined so far, the human body has the following DOFs:</p>
<ul class="simple">
<li>6 DOF because the body as a whole is currently “floating around in space”</li>
<li>3 DOF of the spherical joint between pelvis and thorax rotation</li>
<li>3 DOF of the spherical joint at the neck</li>
<li>3 DOF of the spherical joint at the hip</li>
<li>1 DOF of the revolute joint at the knee</li>
<li>2 DOF of rotation (flexion + eversion) at the ankle</li>
</ul>
<p><strong>Total Human + pedal DOFs adds up to 19. In other words, we to need to specify 19 constraints before the model is kinematically determinate.
We will do this using the concepts of “Measures and Drivers” introduced in</strong> <a class="reference internal" href="../A_Getting_started_anyscript/lesson4.html#measures-and-drivers"><span class="std std-ref">this previous chapter</span></a>.</p>
<p>The following steps specify a total of 19 driver constraints for the model:</p>
<ul class="simple">
<li>Step 1 - 6 DOF constrained by fixing the pelvis rigidly to a point on ground (like a seat).</li>
<li>Step 2 - 3 DOF constrained by locking all 3 rotations between pelvis-thorax</li>
<li>Step 3 - 3 DOF constrained by locking all 3 rotations at neck</li>
<li>Step 4 - 3 DOF constrained by locking 3 translations between pedal and foot (a spherical joint)</li>
<li>Step 5 - 2 DOF constrained by fixing the 2 ankle DOFs</li>
<li>Step 6 - 1 DOF constrained by constraining the global, lateral position of the knee</li>
<li>Step 7 - 1 DOF constrained as pedal rotation at constant velocity</li>
</ul>
<p><strong>Each of these steps is implemented in sequence below.</strong></p>
</div>
<div class="section" id="the-default-mannequin-drivers">
<span id="mannequin-drivers"></span><h2>The “Default mannequin drivers”<a class="headerlink" href="#the-default-mannequin-drivers" title="Permalink to this headline">¶</a></h2>
<p>Do all 19 driver constraints mentioned above need to be added before a kinematic simulation will work? Yes. But there
is one model feature that will make your life easier.</p>
<p><strong>The human model includes “default drivers” which can constrain the human model’s posture
to the joint angles and velocities set in the “Mannequin.any” file.</strong></p>
<p>The constraint enforced by the default drivers are defined as ‘soft’
constraints - constraints that be overridden by the 19 ‘hard constraints’ which we will define.</p>
<p><strong>You can therefore sequentially add the 19 hard drivers on top of the soft default drivers, and deactivate the default
drivers at the</strong> <a class="reference internal" href="#kinematically-determined"><span class="std std-ref">very end of this lesson</span></a> <strong>. The advantage is that you have a model whose
kinematics can be tested at every step along the way.</strong></p>
</div>
<div class="section" id="step-1-fixing-the-pelvis-to-ground">
<h2>Step 1: Fixing the pelvis to ground<a class="headerlink" href="#step-1-fixing-the-pelvis-to-ground" title="Permalink to this headline">¶</a></h2>
<p>The pedal is currently hinged at the origin of the global reference
frame. A “seat” node to which we fix the pelvis must therefore
be displaced by a suitable distance from the origin.</p>
<p>In the “Environment.any” file, add the following within the “GlobalReferenceFrame” object:</p>
<div class="highlight-AnyScriptDoc notranslate"><div class="highlight"><pre><span></span><span class="kt">AnyFixedRefFrame</span> <span class="n">GlobalRef</span> <span class="o">=</span> <span class="p">{</span>
  <span class="gr">AnyRefNode Hpoint = {</span>
<span class="gr">     sRel = {-0.7, 0.5, 0};</span>
<span class="gr">   };</span>
 <span class="p">};</span> <span class="c1">// Global reference frame</span>
</pre></div>
</div>
<p><strong>Reload the model (F7).</strong></p>
<p>Hpoint is a term used in the seating industry to characterize
the position of the pelvis in a seat. Here we shall simply attach the
pelvis to this point by means of a rigid connection.</p>
<p><strong>Drivers which connect the human and environment are traditionally placed in a folder called
“ModelEnvironmentConnection” (</strong> <a class="reference internal" href="lesson1.html#model-structure"><span class="std std-ref">explained here</span></a> <strong>), and for historical reasons, it is placed in
an</strong> <code class="docutils literal highlight highlight-AnyScriptDoc"><span></span><span class="cp">#include</span></code> <strong>file called “JointsAndDrivers.any”. Let’s open this file by
double-clicking of the following line in the main file</strong>:</p>
<div class="highlight-AnyScriptDoc notranslate"><div class="highlight"><pre><span></span><span class="p">...</span>
<span class="cp">#include</span> <span class="s">&quot;Model\JointsAndDrivers.any&quot;</span>
<span class="p">...</span>
</pre></div>
</div>
<p>Then you can see the following structure inside:</p>
<div class="highlight-AnyScriptDoc notranslate"><div class="highlight"><pre><span></span><span class="kt">AnyFolder</span> <span class="n">Joints</span> <span class="o">=</span>
<span class="p">{</span>
<span class="p">};</span>

<span class="kt">AnyFolder</span> <span class="n">Drivers</span> <span class="o">=</span>
<span class="p">{</span>
<span class="p">};</span>
</pre></div>
</div>
<p>Here let’s prepare an <code class="docutils literal highlight highlight-AnyScriptDoc"><span></span><span class="kt">AnyStdJoint</span></code> object named “SeatPelvis” for the fixation of pelvis:</p>
<div class="highlight-AnyScriptDoc notranslate"><div class="highlight"><pre><span></span><span class="kt">AnyFolder</span> <span class="n">Joints</span> <span class="o">=</span>
<span class="p">{</span>
  <span class="gr">AnyStdJoint SeatPelvis =</span>
<span class="gr">  {</span>
<span class="gr">    AnyRefFrame&amp; Seat = ;</span>
<span class="gr">    AnyRefFrame&amp; Pelvis = ;</span>
<span class="gr">  };</span>
<span class="p">};</span>
</pre></div>
</div>
<p>As you’d realize by now, both “Seat” and “Pelvis” are references to the two nodes that
are being connected by the joint.</p>
<p><strong>The “Seat” node must point to the “Hpoint” node attached to “GlobalRef”
frame. “Pelvis” must point to the origin of “PelvisSeg”, which you can find in the model tree at
“HumanModel-&gt;BodyModel-&gt;Trunk-&gt;SegmentsLumbar-&gt;PelvisSeg”.</strong></p>
<p>To find and insert the absolute paths for these nodes into AnyScript, quickly refer back
to <a class="reference internal" href="../A_Getting_started_anyscript/lesson3.html#absolute-folder-path"><span class="std std-ref">this previous section</span></a>.</p>
<p>You should now have the following:</p>
<div class="highlight-AnyScriptDoc notranslate"><div class="highlight"><pre><span></span><span class="kt">AnyFolder</span> <span class="n">Joints</span> <span class="o">=</span>
<span class="p">{</span>
  <span class="kt">AnyStdJoint</span> <span class="n">SeatPelvis</span> <span class="o">=</span>
  <span class="p">{</span>
    <span class="kt">AnyRefFrame</span><span class="o">&amp;</span> <span class="n">Seat</span> <span class="o">=</span> <span class="gr">Main.Model.Environment.GlobalRef.Hpoint</span><span class="p">;</span>
    <span class="kt">AnyRefFrame</span><span class="o">&amp;</span> <span class="n">Pelvis</span> <span class="o">=</span> <span class="gr">Main.HumanModel.BodyModel.Trunk.SegmentsLumbar.PelvisSeg</span><span class="p">;</span>
  <span class="p">};</span>
<span class="p">};</span>
</pre></div>
</div>
<p>Hit F7 to reload the model. The model still loads in
the same position as before.</p>
<p>The initial positions are controlled by the mannequin file. Open it up
by double-clicking the following line, and make the changes show in red:</p>
<div class="highlight-AnyScriptDoc notranslate"><div class="highlight"><pre><span></span><span class="p">...</span>
<span class="cp">#path</span> <span class="x x-Statements">BM_MANNEQUIN_FILE</span> <span class="s">&quot;Model\Mannequin.any&quot;</span>
<span class="p">...</span>
</pre></div>
</div>
<div class="highlight-AnyScriptDoc notranslate"><div class="highlight"><pre><span></span><span class="kt">AnyFolder</span> <span class="n">Mannequin</span> <span class="o">=</span> <span class="p">{</span>

  <span class="kt">AnyFolder</span> <span class="n">Posture</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1">//This controls the position of the pelvis wrt. to the global reference frame</span>
    <span class="kt">AnyVar</span> <span class="n">PelvisPosX</span> <span class="o">=</span> <span class="gr">-0.7</span><span class="p">;</span>
    <span class="kt">AnyVar</span> <span class="n">PelvisPosY</span> <span class="o">=</span> <span class="gr">0.5</span><span class="p">;</span>
    <span class="kt">AnyVar</span> <span class="n">PelvisPosZ</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">...</span>
</pre></div>
</div>
<p>You have specified the load-time position of the
pelvis to the coordinates of the “Hpoint” node. It is also a good idea to specify the initial joint angles
in the leg so that the foot is closer to the pedal. This can be done further down
in the Mannequin file:</p>
<div class="highlight-AnyScriptDoc notranslate"><div class="highlight"><pre><span></span>    <span class="kt">AnyFolder</span> <span class="n">Right</span> <span class="o">=</span> <span class="p">{</span>
      <span class="c1">//Arm</span>
      <span class="kt">AnyVar</span> <span class="n">SternoClavicularProtraction</span><span class="o">=-</span><span class="mi">23</span><span class="p">;</span>   <span class="c1">//This value is not used for initial position</span>
      <span class="kt">AnyVar</span> <span class="n">SternoClavicularElevation</span><span class="o">=</span><span class="mf">11.5</span><span class="p">;</span>    <span class="c1">//This value is not used for initial position</span>
      <span class="kt">AnyVar</span> <span class="n">SternoClavicularAxialRotation</span><span class="o">=-</span><span class="mi">20</span><span class="p">;</span> <span class="c1">//This value is not used for initial position</span>

      <span class="kt">AnyVar</span> <span class="n">GlenohumeralFlexion</span> <span class="o">=-</span><span class="mi">0</span><span class="p">;</span>
      <span class="kt">AnyVar</span> <span class="n">GlenohumeralAbduction</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
      <span class="kt">AnyVar</span> <span class="n">GlenohumeralExternalRotation</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

      <span class="kt">AnyVar</span> <span class="n">ElbowFlexion</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">;</span>
      <span class="kt">AnyVar</span> <span class="n">ElbowPronation</span> <span class="o">=</span> <span class="o">-</span><span class="mf">20.0</span><span class="p">;</span>

      <span class="kt">AnyVar</span> <span class="n">WristFlexion</span> <span class="o">=</span><span class="mi">0</span><span class="p">;</span>
      <span class="kt">AnyVar</span> <span class="n">WristAbduction</span> <span class="o">=</span><span class="mi">0</span><span class="p">;</span>

      <span class="c1">//Leg</span>
      <span class="kt">AnyVar</span> <span class="n">HipFlexion</span> <span class="o">=</span> <span class="gr">110.0</span><span class="p">;</span>
      <span class="kt">AnyVar</span> <span class="n">HipAbduction</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">;</span>
      <span class="kt">AnyVar</span> <span class="n">HipExternalRotation</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>

      <span class="kt">AnyVar</span> <span class="n">KneeFlexion</span> <span class="o">=</span> <span class="gr">100.0</span><span class="p">;</span>

      <span class="kt">AnyVar</span> <span class="n">AnklePlantarFlexion</span> <span class="o">=</span><span class="mf">0.0</span><span class="p">;</span>
      <span class="kt">AnyVar</span> <span class="n">SubTalarEversion</span> <span class="o">=</span><span class="mf">0.0</span><span class="p">;</span>
<span class="p">...</span>
</pre></div>
</div>
<p><strong>On reload, you will see that the body now loads in pretty much the
desired position. Notice that this is only to bring the body close to
where it will eventually be. It is not necessary to align the model
exactly with the pedal. The kinematic constraints will take care of this
once they are properly defined.</strong></p>
<p><a class="reference internal" href="../_images/image19.png"><img alt="Posture Adjustment1" src="../_images/image19.png" style="height: 300px;" /></a></p>
</div>
<div class="section" id="step-2-locking-pelvis-thorax-rotation">
<h2>Step 2: Locking pelvis-thorax rotation<a class="headerlink" href="#step-2-locking-pelvis-thorax-rotation" title="Permalink to this headline">¶</a></h2>
<p>The only purpose of the trunk in this model is to anchor the psoas muscles which move
the leg. So we will set to zero, the angles and velocities of 3 DOF of pelvis-thorax flexion, lateral bending and axial rotation.</p>
<p>We will place the drivers enforcing these constraints in the “Drivers” folder within “JointsAndDrivers.any” (shown below):</p>
<div class="highlight-AnyScriptDoc notranslate"><div class="highlight"><pre><span></span><span class="kt">AnyFolder</span> <span class="n">Joints</span> <span class="o">=</span>
<span class="p">{</span>
  <span class="kt">AnyStdJoint</span> <span class="n">SeatPelvis</span> <span class="o">=</span>
  <span class="p">{</span>
    <span class="kt">AnyRefFrame</span><span class="o">&amp;</span> <span class="n">Seat</span> <span class="o">=</span> <span class="n">Main</span><span class="p">.</span><span class="n">Model</span><span class="p">.</span><span class="n">Environment</span><span class="p">.</span><span class="n">GlobalRef</span><span class="p">.</span><span class="n">Hpoint</span><span class="p">;</span>
    <span class="kt">AnyRefFrame</span><span class="o">&amp;</span> <span class="n">Pelvis</span> <span class="o">=</span> <span class="n">Main</span><span class="p">.</span><span class="n">HumanModel</span><span class="p">.</span><span class="n">BodyModel</span><span class="p">.</span><span class="n">Trunk</span><span class="p">.</span><span class="n">SegmentsLumbar</span><span class="p">.</span><span class="n">PelvisSeg</span><span class="p">;</span>
  <span class="p">};</span>
<span class="p">};</span>

<span class="kt">AnyFolder</span> <span class="n">Drivers</span> <span class="o">=</span>
<span class="p">{</span>

<span class="p">};</span>
</pre></div>
</div>
<p>Insert a”PelvisThoraxDriver” into the Drivers folder, created using the <code class="docutils literal highlight highlight-AnyScriptDoc"><span></span><span class="kt">AnyKinEqSimpleDriver</span></code> class.
You already know how to create model objects from scratch by using the
the “Class Inserter” (<a class="reference internal" href="../A_Getting_started_anyscript/lesson2.html#class-inserter"><span class="std std-ref">described here</span></a>). More details on properties
such as DriverPos, DriverVel etc. can be (<a class="reference internal" href="../A_Getting_started_anyscript/lesson4.html#anykineqsimpledriver"><span class="std std-ref">found here</span></a>) :</p>
<div class="highlight-AnyScriptDoc notranslate"><div class="highlight"><pre><span></span><span class="kt">AnyFolder</span> <span class="n">Drivers</span> <span class="o">=</span>
<span class="p">{</span>
  <span class="gr">AnyKinEqSimpleDriver PelvisThoraxDriver =</span>
<span class="gr">  {</span>
<span class="gr">    AnyKinMeasure&amp; ref0 = ...HumanModel.BodyModel.Interface.Trunk.PelvisThoraxExtension;</span>
<span class="gr">    AnyKinMeasure&amp; ref1 = ...HumanModel.BodyModel.Interface.Trunk.PelvisThoraxLateralBending;</span>
<span class="gr">    AnyKinMeasure&amp; ref2 = ...HumanModel.BodyModel.Interface.Trunk.PelvisThoraxRotation;</span>

<span class="gr">    DriverPos = pi/180*{0,0,0};</span>
<span class="gr">    DriverVel = pi/180*{0,0,0};</span>
<span class="gr">  };</span>
<span class="p">};</span>
</pre></div>
</div>
</div>
<div class="section" id="step-3-locking-neck-rotation">
<h2>Step 3: Locking neck rotation<a class="headerlink" href="#step-3-locking-neck-rotation" title="Permalink to this headline">¶</a></h2>
<p>The following lines lock all 3 DOFs of rotation between the skull and the thorax (neck). The
drivers are defined in a manner that is very similar to Step 2.</p>
<div class="highlight-AnyScriptDoc notranslate"><div class="highlight"><pre><span></span><span class="kt">AnyFolder</span> <span class="n">Drivers</span> <span class="o">=</span>
<span class="p">{</span>
  <span class="kt">AnyKinEqSimpleDriver</span> <span class="n">PelvisThoraxDriver</span> <span class="o">=</span>
  <span class="p">{</span>
    <span class="kt">AnyKinMeasure</span><span class="o">&amp;</span> <span class="n">ref0</span> <span class="o">=</span> <span class="p">...</span><span class="n">HumanModel</span><span class="p">.</span><span class="n">BodyModel</span><span class="p">.</span><span class="n">Interface</span><span class="p">.</span><span class="n">Trunk</span><span class="p">.</span><span class="n">PelvisThoraxExtension</span><span class="p">;</span>
    <span class="kt">AnyKinMeasure</span><span class="o">&amp;</span> <span class="n">ref1</span> <span class="o">=</span> <span class="p">...</span><span class="n">HumanModel</span><span class="p">.</span><span class="n">BodyModel</span><span class="p">.</span><span class="n">Interface</span><span class="p">.</span><span class="n">Trunk</span><span class="p">.</span><span class="n">PelvisThoraxLateralBending</span><span class="p">;</span>
    <span class="kt">AnyKinMeasure</span><span class="o">&amp;</span> <span class="n">ref2</span> <span class="o">=</span> <span class="p">...</span><span class="n">HumanModel</span><span class="p">.</span><span class="n">BodyModel</span><span class="p">.</span><span class="n">Interface</span><span class="p">.</span><span class="n">Trunk</span><span class="p">.</span><span class="n">PelvisThoraxRotation</span><span class="p">;</span>

    <span class="n">DriverPos</span> <span class="o">=</span> <span class="kp">pi</span><span class="o">/</span><span class="mi">180</span><span class="o">*</span><span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">};</span>
    <span class="n">DriverVel</span> <span class="o">=</span> <span class="kp">pi</span><span class="o">/</span><span class="mi">180</span><span class="o">*</span><span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">};</span>
  <span class="p">};</span>


  <span class="gr">AnyKinEqSimpleDriver SkullThoraxDriver =</span>
<span class="gr">  {</span>
<span class="gr">    AnyKinMeasure&amp; ref0 = ...HumanModel.BodyModel.Interface.Trunk.SkullThoraxFlexion;</span>
<span class="gr">    AnyKinMeasure&amp; ref1 = ...HumanModel.BodyModel.Interface.Trunk.SkullThoraxLateralBending;</span>
<span class="gr">    AnyKinMeasure&amp; ref2 = ...HumanModel.BodyModel.Interface.Trunk.SkullThoraxRotation;</span>

<span class="gr">    DriverPos = pi/180*{0,0,0};</span>
<span class="gr">    DriverVel = pi/180*{0,0,0};</span>
<span class="gr">  };</span>
<span class="p">};</span>
</pre></div>
</div>
</div>
<div class="section" id="step-4-connecting-the-foot-to-the-pedal">
<h2>Step 4: Connecting the foot to the pedal<a class="headerlink" href="#step-4-connecting-the-foot-to-the-pedal" title="Permalink to this headline">¶</a></h2>
<p>The foot will be connected to the pedal by a spherical joint. We have assumed
the connection node on the foot to be the “MetatarsalJoint2Node”. The driver is
defined inside the “JointsAndDrivers.any” file in the following way:</p>
<div class="highlight-AnyScriptDoc notranslate"><div class="highlight"><pre><span></span><span class="kt">AnyFolder</span> <span class="n">Joints</span> <span class="o">=</span>
<span class="p">{</span>
  <span class="kt">AnyStdJoint</span> <span class="n">SeatPelvis</span> <span class="o">=</span>
  <span class="p">{</span>
    <span class="kt">AnyRefFrame</span><span class="o">&amp;</span> <span class="n">Seat</span> <span class="o">=</span> <span class="n">Main</span><span class="p">.</span><span class="n">Model</span><span class="p">.</span><span class="n">Environment</span><span class="p">.</span><span class="n">GlobalRef</span><span class="p">.</span><span class="n">Hpoint</span><span class="p">;</span>
    <span class="kt">AnyRefFrame</span><span class="o">&amp;</span> <span class="n">Pelvis</span> <span class="o">=</span> <span class="n">Main</span><span class="p">.</span><span class="n">HumanModel</span><span class="p">.</span><span class="n">BodyModel</span><span class="p">.</span><span class="n">Trunk</span><span class="p">.</span><span class="n">SegmentsLumbar</span><span class="p">.</span><span class="n">PelvisSeg</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="gr">AnySphericalJoint PedalFoot =</span>
<span class="gr">  {</span>
<span class="gr">    AnyRefFrame&amp; Pedal = Main.Model.Environment.Pedal.FootNode;</span>
<span class="gr">    AnyRefFrame&amp; Foot = Main.HumanModel.BodyModel.Right.Leg.Seg.Foot.MetatarsalJoint2Node;</span>
<span class="gr">  }; </span>
<span class="p">};</span>
</pre></div>
</div>
</div>
<div class="section" id="step-5-locking-the-ankle-angles">
<h2>Step 5: Locking the ankle angles<a class="headerlink" href="#step-5-locking-the-ankle-angles" title="Permalink to this headline">¶</a></h2>
<p>In ankle has 2 DOFs - AnklePlantarFlexion and SubTarEversion. We will constrain both
DOFs to always equal zero. Just as in Steps 3 &amp; 4, this will be done using <code class="docutils literal highlight highlight-AnyScriptDoc"><span></span><span class="kt">AnyKinEqSimpleDriver</span></code>:</p>
<div class="highlight-AnyScriptDoc notranslate"><div class="highlight"><pre><span></span><span class="kt">AnyFolder</span> <span class="n">Drivers</span> <span class="o">=</span>
<span class="p">{</span>
<span class="p">...</span>
  <span class="kt">AnyKinEqSimpleDriver</span> <span class="n">SkullThoraxDriver</span> <span class="o">=</span>
  <span class="p">{</span>
    <span class="kt">AnyKinMeasure</span><span class="o">&amp;</span> <span class="n">ref0</span> <span class="o">=</span> <span class="p">...</span><span class="n">HumanModel</span><span class="p">.</span><span class="n">BodyModel</span><span class="p">.</span><span class="n">Interface</span><span class="p">.</span><span class="n">Trunk</span><span class="p">.</span><span class="n">SkullThoraxFlexion</span><span class="p">;</span>
    <span class="kt">AnyKinMeasure</span><span class="o">&amp;</span> <span class="n">ref1</span> <span class="o">=</span> <span class="p">...</span><span class="n">HumanModel</span><span class="p">.</span><span class="n">BodyModel</span><span class="p">.</span><span class="n">Interface</span><span class="p">.</span><span class="n">Trunk</span><span class="p">.</span><span class="n">SkullThoraxLateralBending</span><span class="p">;</span>
    <span class="kt">AnyKinMeasure</span><span class="o">&amp;</span> <span class="n">ref2</span> <span class="o">=</span> <span class="p">...</span><span class="n">HumanModel</span><span class="p">.</span><span class="n">BodyModel</span><span class="p">.</span><span class="n">Interface</span><span class="p">.</span><span class="n">Trunk</span><span class="p">.</span><span class="n">SkullThoraxRotation</span><span class="p">;</span>

    <span class="n">DriverPos</span> <span class="o">=</span> <span class="kp">pi</span><span class="o">/</span><span class="mi">180</span><span class="o">*</span><span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">};</span>
    <span class="n">DriverVel</span> <span class="o">=</span> <span class="kp">pi</span><span class="o">/</span><span class="mi">180</span><span class="o">*</span><span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">};</span>
  <span class="p">};</span>

  <span class="gr">AnyKinEqSimpleDriver AnkleDriver =</span>
<span class="gr">  {</span>
<span class="gr">    AnyKinMeasure&amp; ref0 = ...HumanModel.BodyModel.Interface.Right.AnklePlantarFlexion;</span>
<span class="gr">    AnyKinMeasure&amp; ref1 = ...HumanModel.BodyModel.Interface.Right.SubTalarEversion;</span>

<span class="gr">    DriverPos = pi/180*{0, 0};</span>
<span class="gr">    DriverVel = pi/180*{0, 0};</span>
<span class="gr">   };</span>
<span class="p">};</span>
</pre></div>
</div>
<p>Re-loading the model should show no significant differences.</p>
</div>
<div class="section" id="step-6-fix-the-lateral-position-of-the-knee">
<h2>Step 6: Fix the lateral position of the knee<a class="headerlink" href="#step-6-fix-the-lateral-position-of-the-knee" title="Permalink to this headline">¶</a></h2>
<p>Imagine your pelvis on a seat (like in Step 1) and your foot resting at the tip of a sharp spike jutting
out of the ground (a spherical joint connection, like in Step 4). You can still move your knee sideways.
You will now constrain this medio-lateral knee movement in your model.</p>
<p>This is done using an <code class="docutils literal highlight highlight-AnyScriptDoc"><span></span><span class="kt">AnyKinLinear</span></code> measure and a <code class="docutils literal highlight highlight-AnyScriptDoc"><span></span><span class="kt">AnyKinEqSimpleDriver</span></code> driver acting on that measure
(<a class="reference internal" href="../A_Getting_started_anyscript/lesson4.html#measures-and-drivers"><span class="std std-ref">read more one measures &amp; drivers here</span></a>):</p>
<div class="highlight-AnyScriptDoc notranslate"><div class="highlight"><pre><span></span><span class="kt">AnyFolder</span> <span class="n">Drivers</span> <span class="o">=</span>
<span class="p">{</span>
<span class="p">...</span>
  <span class="kt">AnyKinEqSimpleDriver</span> <span class="n">AnkleDriver</span> <span class="o">=</span>
  <span class="p">{</span>
    <span class="kt">AnyKinMeasure</span><span class="o">&amp;</span> <span class="n">ref0</span> <span class="o">=</span> <span class="p">...</span><span class="n">HumanModel</span><span class="p">.</span><span class="n">BodyModel</span><span class="p">.</span><span class="n">Interface</span><span class="p">.</span><span class="n">Right</span><span class="p">.</span><span class="n">AnklePlantarFlexion</span><span class="p">;</span>
    <span class="kt">AnyKinMeasure</span><span class="o">&amp;</span> <span class="n">ref1</span> <span class="o">=</span> <span class="p">...</span><span class="n">HumanModel</span><span class="p">.</span><span class="n">BodyModel</span><span class="p">.</span><span class="n">Interface</span><span class="p">.</span><span class="n">Right</span><span class="p">.</span><span class="n">SubTalarEversion</span><span class="p">;</span>

    <span class="n">DriverPos</span> <span class="o">=</span> <span class="kp">pi</span><span class="o">/</span><span class="mi">180</span><span class="o">*</span><span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">};</span>
    <span class="n">DriverVel</span> <span class="o">=</span> <span class="kp">pi</span><span class="o">/</span><span class="mi">180</span><span class="o">*</span><span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">};</span>
  <span class="p">};</span>

  <span class="gr">AnyKinEqSimpleDriver KneeDriver =</span>
<span class="gr">  {</span>
<span class="gr">    AnyKinLinear lin =</span>
<span class="gr">    {</span>
<span class="gr">      AnyRefFrame&amp; ref0 = Main.Model.Environment.GlobalRef;</span>
<span class="gr">      AnyRefFrame&amp; ref1 = Main.HumanModel.BodyModel.Right.Leg.Seg.Thigh.KneeJoint;</span>
<span class="gr">      Ref = 0;</span>
<span class="gr">    };</span>
<span class="gr">    MeasureOrganizer = {2};</span>
<span class="gr">    DriverPos = {0};</span>
<span class="gr">    DriverVel = {0};</span>
<span class="gr">   }; </span>
<span class="p">};</span>
</pre></div>
</div>
<p>The <code class="docutils literal highlight highlight-AnyScriptDoc"><span></span><span class="kt">AnyKinLinear</span></code> object measures the 3D position vector between the two reference
frames <code class="docutils literal highlight highlight-AnyScriptDoc"><span></span><span class="n">ref0</span></code> and <code class="docutils literal highlight highlight-AnyScriptDoc"><span></span><span class="n">ref1</span></code> which it refers to, i.e., in this case, the position of the knee
with respect to the global reference frame.</p>
<p><strong>We however, only wish to constrain the medio-lateral component of this vector, which is the global
“Z” component. We hence specify the</strong> <code class="docutils literal highlight highlight-AnyScriptDoc"><span></span><span class="n">MeasureOrganizer</span></code> <strong>property to specify that only the 3rd component of the measure
which is given by the index 2 (0 being X, 1 being Y component) must be constrained by the driver.</strong></p>
</div>
<div class="section" id="step-7-specify-pedal-movement">
<h2>Step 7: Specify pedal movement<a class="headerlink" href="#step-7-specify-pedal-movement" title="Permalink to this headline">¶</a></h2>
<p>We will specify motion for the pedal’s hinge joint again using the <code class="docutils literal highlight highlight-AnyScriptDoc"><span></span><span class="kt">AnyKinEqSimpleDriver</span></code>.
This resembles what you did in <a class="reference internal" href="../A_Getting_started_anyscript/lesson4.html#anykineqsimpledriver"><span class="std std-ref">this earlier chapter</span></a>.</p>
<div class="highlight-AnyScriptDoc notranslate"><div class="highlight"><pre><span></span><span class="kt">AnyFolder</span> <span class="n">Drivers</span> <span class="o">=</span>
<span class="p">{</span>
<span class="p">...</span>
  <span class="kt">AnyKinEqSimpleDriver</span> <span class="n">KneeDriver</span> <span class="o">=</span>
  <span class="p">{</span>
    <span class="kt">AnyKinLinear</span> <span class="n">lin</span> <span class="o">=</span>
    <span class="p">{</span>
      <span class="kt">AnyRefFrame</span><span class="o">&amp;</span> <span class="n">ref0</span> <span class="o">=</span> <span class="n">Main</span><span class="p">.</span><span class="n">Model</span><span class="p">.</span><span class="n">Environment</span><span class="p">.</span><span class="n">GlobalRef</span><span class="p">;</span>
      <span class="kt">AnyRefFrame</span><span class="o">&amp;</span> <span class="n">ref1</span> <span class="o">=</span> <span class="n">Main</span><span class="p">.</span><span class="n">HumanModel</span><span class="p">.</span><span class="n">BodyModel</span><span class="p">.</span><span class="n">Right</span><span class="p">.</span><span class="n">Leg</span><span class="p">.</span><span class="n">Seg</span><span class="p">.</span><span class="n">Thigh</span><span class="p">.</span><span class="n">KneeJoint</span><span class="p">;</span>
      <span class="n">Ref</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">};</span>
    <span class="n">MeasureOrganizer</span> <span class="o">=</span> <span class="p">{</span><span class="mi">2</span><span class="p">};</span>
    <span class="n">DriverPos</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
    <span class="n">DriverVel</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
  <span class="p">};</span>

  <span class="gr">AnyKinEqSimpleDriver PedalDriver =</span>
<span class="gr">  {</span>
<span class="gr">    AnyKinMeasure &amp;ref0 = Main.Model.Environment.HingeJoint;</span>
<span class="gr">    DriverPos = pi/180*{100};</span>
<span class="gr">    DriverVel = pi/180*{45};</span>
<span class="gr">  };</span>
<span class="p">};</span>
</pre></div>
</div>
<p>This puts the pedal in an initial 100-degree angle compared to vertical, from where
this angle increases as a rate of 45 degrees per second.</p>
<p><strong>For now, hit F7 again to reload the model. Notice that the system no
longer complains about the model being kinematically indeterminate.</strong></p>
</div>
<div class="section" id="running-kinematics">
<h2>Running kinematics<a class="headerlink" href="#running-kinematics" title="Permalink to this headline">¶</a></h2>
<p>Select and run the ‘Main.Study.Kinematics’ operation from the operations dropdown menu (<a class="reference internal" href="../A_Getting_started/lesson2.html#running-analysis"><span class="std std-ref">more info here</span></a>).
This will show you the movement of the entire system as the pedal is rotating.</p>
<p><img alt="Operation Result Kinematics" src="../_images/image35.png" /></p>
</div>
<div class="section" id="check-if-model-is-kinematically-determined">
<span id="kinematically-determined"></span><h2>Check if model is kinematically determined?<a class="headerlink" href="#check-if-model-is-kinematically-determined" title="Permalink to this headline">¶</a></h2>
<p>Finally, you will check the number of DOFs and the number of kinematic
constraints in the simulation from the “Object Description” of your “Study” object.
You can find this here:</p>
<p><img alt="Operations tree object description" src="../_images/image44.png" /></p>
<p>Then you see the Object Description dialog will open.</p>
<p><img alt="ObjectDescription DOFs" src="../_images/image56.png" /></p>
<p><strong>This indicates that the total number of DOFs(degrees of freedom) in your
model is 132. It makes sense because there are 21 segments in your model
and each segment has 6 DOFs.</strong></p>
<p>If you scroll down this dialog a little bit more, then you can see the
following section:</p>
<p><img alt="ObjectDescription Constraints1" src="../_images/image62.png" /></p>
<p><strong>The last message in the above screenshot lets us know that there are 150
constraints from the joints and the drivers in the model.</strong></p>
<p>In general, the total number of DOFs in the model should be exactly as
same as the total number of kinematic constraints in the model. But at
the moment, the number of kinematic constraints is larger than that of
DOFs.</p>
<p><strong>In some cases, having more constraints than DOFs (also called a redundant set of constraints) results in a failed kinematic simulation,
because the system is over-constrained.</strong></p>
<p>However our AnyBody model seems to work despite this constraint redundancy. Why?</p>
<p>This is because, these 150 - 132 = 18 “extra” constraints were also “soft” constraints enforced by the
“default mannequin drivers” described <a class="reference internal" href="#mannequin-drivers"><span class="std std-ref">here earlier</span></a>.</p>
<p>The “DefaultMannequinDrivers” can be found in a subfolder of the “HumanModel” folder, as shown in the figure below.
These drivers control the human model’s posture based on the values in the “Mannequin.any” file.</p>
<p><img alt="Model tree Default manequin drivers" src="../_images/image71.png" /></p>
<p>Because these default drivers are defined as “Soft” constraints, they were compromised in
favour of the “Hard” constraints specified in Steps 1 to 7 in this document.</p>
<p>This avoided an over-constrained situation and kinematics could therefore be solved.</p>
<p>Since you could define all necessary “Hard” constraints,
the default drivers can now be removed by just adding one more BM statement to the main file:</p>
<div class="highlight-AnyScriptDoc notranslate"><div class="highlight"><pre><span></span><span class="c1">//--&gt;BM statements</span>
  <span class="c1">// Excluding the muscles in the trunk segments</span>
  <span class="cp">#define</span> <span class="x x-Statements">BM_TRUNK_MUSCLES</span> <span class="x x-Options">_MUSCLES_NONE_</span>
  <span class="c1">// Excluding the left arm segments</span>
  <span class="cp">#define</span> <span class="x x-Statements">BM_ARM_LEFT</span> <span class="x x-Options">OFF</span>
  <span class="c1">// Excluding the right arm segments</span>
  <span class="cp">#define</span> <span class="x x-Statements">BM_ARM_RIGHT</span> <span class="x x-Options">OFF</span>
  <span class="c1">// Excluding the left leg segments</span>
  <span class="cp">#define</span> <span class="x x-Statements">BM_LEG_LEFT</span> <span class="x x-Options">OFF</span>
  <span class="c1">// Using the right leg as &#39;TLEM&#39; model</span>
  <span class="cp">#define</span> <span class="x x-Statements">BM_LEG_RIGHT</span> <span class="x x-Options">_LEG_MODEL_TLEM1_</span>
  <span class="c1">// Excluding the muscles in the right leg segments</span>
  <span class="cp">#define</span> <span class="x x-Statements">BM_LEG_MUSCLES_RIGHT</span> <span class="x x-Options">_MUSCLES_NONE_</span>
  <span class="c1">// Excluding the default drivers for the human model</span>
  <span class="gr">#define BM_MANNEQUIN_DRIVER_DEFAULT OFF</span>
  <span class="c1">//&lt;--</span>
</pre></div>
</div>
<p>Save the main file and press F7 button to reload the model. And try to
open the Object Description dialog of “Study” object in the Model Tree.</p>
<p><img alt="ObjectDescription Constraints2" src="../_images/image81.png" /></p>
<p>You see that now the total number of constraints has been changed to 132
and this is exactly as same as the total number of DOFs. Of course, you
can still run the kinematics of your model.</p>
<div class="without-title admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last"><strong>Next lesson:</strong> Now that the kinematics is in order let us move on to the <a class="reference internal" href="lesson4.html"><span class="doc">kinetic
analysis in Lesson 4 and see what the model is good
for.</span></a></p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
        <p class="logo"><a href="../index.html" title="index">
          <img class="logo" src="../_static/anybody_tutorials_logo.png" alt="Logo"/>
        </a></p>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
<div class="sphinx-toc sphinxglobaltoc">
<h3><a href="../contents.html">Table of Contents</a></h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../index.html">Tutorial overview</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../A_Getting_started/index.html">1. Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../A_Getting_started_anyscript/index.html">2. Getting started: AnyScript Programming</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">3. Getting Started with Modeling</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="intro.html">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="lesson1.html">Lesson 1: Starting with a New Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="lesson2.html">Lesson 2: Adjusting the Human Model</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Lesson 3: Making Ends Meet</a></li>
<li class="toctree-l2"><a class="reference internal" href="lesson4.html">Lesson 4: Kinetics - Computing Forces</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../A_Getting_started_AMMR/index.html">4. Getting started: The Model Repository</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Interface_features/index.html">5. User interface features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../A_study_of_studies/index.html">6. A Study of Studies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Making_things_move/index.html">7. Making things move</a></li>
<li class="toctree-l1"><a class="reference internal" href="../MuscleRecruitment/index.html">8. Inverse Dynamics of Muscle Systems</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ForceDependentKinematics/index.html">9. Force-Dependent Kinematics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Muscle_modeling/index.html">10. Muscle Modeling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../The_mechanical_elements/index.html">11. The Mechanical Elements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Advanced_script_features/index.html">12. Advanced Script Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Finite_element_analysis/index.html">13. Finite Element Analysis Interfacing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../AnyExp4SOLIDWORKS/index.html">14. Making Models using SOLIDWORKS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Scaling/index.html">15. Personalizing Your Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Validation_of_models/index.html">16. Validation of Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Parameter_studies_and_optimization/index.html">17. Parameter Studies and Optimization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Troubleshooting_anyscript/intro.html">18. Trouble Shooting AnyScript Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Posture_and_movement/intro.html">19. Posture and Movement Prediction</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../legal.html">Legal, Trademarks and Copyrights</a></li>
</ul>
</div><h3>Tutorials not working?</h3>
<p><a href="https://github.com/AnyBody/anybody-tutorial/issues/"><img src="_static/mark-github.svg"></img> Please report it here...</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/A_Getting_started_modeling/lesson3.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
        </div>
      </div>
    
    
        <div class="sidebar-toggle-group no-js">
            
            <button class="sidebar-toggle" id="sidebar-hide" title="Hide the sidebar menu">
                 «
                <span class="show-for-small">hide menu</span>
                
            </button>
            <button class="sidebar-toggle" id="sidebar-show" title="Show the sidebar menu">
                
                <span class="show-for-small">menu</span>
                <span class="hide-for-small">sidebar</span>
                 »
            </button>
        </div>
    
      <div class="clearer"></div>
    </div>
    <div class="relbar-bottom">
        
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../contents.html" title="Table Of Contents"
             >toc</a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="lesson4.html" title="Lesson 4: Kinetics - Computing Forces"
             >next</a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="lesson2.html" title="Lesson 2: Adjusting the Human Model"
             >previous</a> &nbsp; &nbsp;</li>
    <li><a href="../index.html">AnyBody Tutorials v7.2.0-dev</a> &#187;</li>

          <li class="nav-item nav-item-1"><a href="index.html" >3. Getting Started with Modeling</a> &#187;</li> 
      </ul>
    </div>
    </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2019, AnyBody Technology.
    </div>
    <!-- cloud_sptheme 1.4 -->
  </body>
</html>