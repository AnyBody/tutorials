


<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Lesson 3: Scaling individual segments based on subject-specific data from medical images &#8212; AnyBody Tutorials v7.0.1 Documentation</title>
    <link rel="stylesheet" href="../_static/cloud.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noticia+Text|Open+Sans|Droid+Sans+Mono" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '7.0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../_static/jquery.cookie.js"></script>
    <script type="text/javascript" src="../_static/cloud.base.js"></script>
    <script type="text/javascript" src="../_static/cloud.js"></script>
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Appendix: Scaling based on Patient-Specific Landmarks" href="lesson3_appendix.html" />
    <link rel="prev" title="Lesson 2: Scaling based on External Body Measurements" href="lesson2.html" /> 
        <meta name="viewport" content="width=device-width, initial-scale=1">
  </head>
  <body>
    <div class="relbar-top">
        
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../contents.html" title="Table Of Contents"
             accesskey="C">toc</a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="lesson3_appendix.html" title="Appendix: Scaling based on Patient-Specific Landmarks"
             accesskey="N">next</a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="lesson2.html" title="Lesson 2: Scaling based on External Body Measurements"
             accesskey="P">previous</a> &nbsp; &nbsp;</li>
    <li><a href="../index.html">AnyBody Tutorials v7.0.1 Documentation</a> &#187;</li>

          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">Scaling</a> &#187;</li> 
      </ul>
    </div>
    </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="lesson-3-scaling-individual-segments-based-on-subject-specific-data-from-medical-images">
<h1>Lesson 3: Scaling individual segments based on subject-specific data from medical images<a class="headerlink" href="#lesson-3-scaling-individual-segments-based-on-subject-specific-data-from-medical-images" title="Permalink to this headline">¶</a></h1>
<p>This tutorial presumes that you have completed <a class="reference internal" href="lesson1.html"><span class="doc">Scaling tutorial Lesson
1: Joint to joint scaling methods</span></a> and <a class="reference internal" href="lesson2.html"><span class="doc">Scaling
tutorial Lesson 2: Scaling based on external body
measurements</span></a>.</p>
<p>This lesson introduces an advanced approach to scaling based on a
sequence of affine and non-affine transformations. Each of these
transforms is constructed based either on subject-specific geometry or
on a set of landmarks selected on the bone surface. As opposed to
Lessons 1 and 2, this lesson is rather methodological than conceptual
and provides a good overview of how to pipeline and combine different 3D
transforms to obtain subject-specific morphing and registration between
frames of reference.</p>
<div class="section" id="linear-point-based-scaling">
<h2>Linear point-based scaling<a class="headerlink" href="#linear-point-based-scaling" title="Permalink to this headline">¶</a></h2>
<p>Previously described scaling schemes are based on anthropometric
measurements and affine transform scaling. Such schemes are good
assumptions when more accurate measurements are not feasible or not
available. Therefore, these schemes are used quite often. However, a
natural next step would be to improve the precision of a model by
utilizing available medical images. These can be used to reconstruct
subject-specific geometry used for modeling purposes. Medical images
contain more detailed information about the bone shape and local
deformities that cannot be handled by the anthropometric regression
equations.</p>
<p>The simplest inclusion of the subject-specific bone shape from medical
image data is to find the affine (linear) transformation that fits a
number of corresponding points that are selected on the source and the
target geometries. These points could be fitted e.g. in a least-squares
manner. This approach is similar to utilizing external body measurements
as it relies on a linear transform. However, it is less dependent on the
bone orientation and prior knowledge of dimensions to be measured. For
example, you can locate any two points on source and target surface
consistently without thinking of how a segment length was measured.</p>
<p>Let us make a simple example of using landmark-based affine scaling.
First, please download two femur surfaces,
<a class="reference download internal" href="../_downloads/SourceFemur.stl" download=""><code class="xref download docutils literal"><span class="pre">SourceFemur.stl</span></code></a> and
<a class="reference download internal" href="../_downloads/TargetFemur.stl" download=""><code class="xref download docutils literal"><span class="pre">TargetFemur.stl</span></code></a> and save them in your
working directory. These femur geometries will be used for the rest of
this tutorial. The source surface is an unscaled femur used in the
standard AnyBody models in the AMMR. The target surface is a femur
reconstructed from a CT image and saved as a surface mesh in STL format
(courtesy of Prof. Sebastian Dendorfer, University of Regensburg,
Germany).</p>
<p>Next, please download the AnyScript file
<a class="reference download internal" href="../_downloads/lesson3a.Main.any" download=""><code class="xref download docutils literal"><span class="pre">lesson3a.main.any</span></code></a>. This file contains
a model with two segments which contain the definition of a surface
each, one for the source and one for the target bone. When we load this
model, the Model View should show the following picture:</p>
<p><a class="reference internal" href="../_images/image140.png"><img alt="Two femurs" src="../_images/image140.png" style="width: 6.68750in; height: 2.60417in;" /></a></p>
<p>To define a new scaling law let us insert a new AnyFunTransform3DLin2
object after the target segment:</p>
<div class="highlight-AnyScriptDoc"><div class="highlight"><pre><span></span><span class="gr">AnyFunTransform3DLin2 &lt;ObjectName&gt; =</span>
<span class="gr">{</span>
<span class="gr">  //PreTransforms = {};</span>
<span class="gr">  Points0 = ;</span>
<span class="gr">  Points1 = ;</span>
<span class="gr">  //Mode = VTK_LANDMARK_RIGIDBODY;</span>
<span class="gr">};</span>
</pre></div>
</div>
<p>The AnyFunTransform3DLin2 object allows us to build a transform that
fits a set of source and target landmarks in a least-squares manner as
mentioned before. The object constructs a linear transforms in a full
affine (linear transformation with translation, rotation, size-scaling
and skewing, i.e. 12 degrees of freedom), uniform (orthogonal rotation
with uniform scaling and translation, i.e., 9 d.o.f.), or rigid-body
manner (orthogonal rotation of unscaled object with translation, i.e., 6
d.o.f.). Please note that the AnyFunTransform3DLin2 object utilizes the
vtk-function/filter <em>vtkLandmarkTransform</em>, and, therefore inherits its
modes:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">VTK_LANDMARK_AFFINE</span></code></li>
<li><code class="docutils literal"><span class="pre">VTK_LANDMARK_SIMILARITY</span></code></li>
<li><code class="docutils literal"><span class="pre">VTK_LANDMARK_RIGIDBODY</span></code></li>
</ul>
<p>A description of this function can be found
<a class="reference external" href="http://davis.lbl.gov/Manuals/VTK-4.5/classvtkLandmarkTransform.html#w0">here</a>.</p>
<p>For this example we want to fit one surface into the other by using a
full affine transform. Therefore, we select several corresponding points
on the surfaces and put them into the two point-sets called Points0 and
Points1, which are the source and target points, respectively. As next
step, we change the mode of the AnyFunTransform3DLin2 object to
VFK_LANDMARK_AFFINE to use the affine transform:</p>
<div class="highlight-AnyScriptDoc"><div class="highlight"><pre><span></span><span class="kt">AnyFunTransform3DLin2</span> <span class="gr">MyTransform</span> <span class="o">=</span>
<span class="p">{</span>
  <span class="c1">//PreTransforms = {};</span>
  <span class="n">Points0</span> <span class="o">=</span>
      <span class="gr">{{0.0138, 0.0014, 0.0274},    // fovea capitis</span>
<span class="gr">      {0.0791,-0.3971,-0.0524},    // lateral anterior condyle</span>
<span class="gr">      {0.094, -0.3954,-0.0183},    // medial anterior condyle</span>
<span class="gr">      {0.0381,-0.1886,-0.0388},    // anterior mid shaft</span>
<span class="gr">      {0.0188,-0.3965,-0.0205},    // lateral posterior condyle</span>
<span class="gr">      {0.0369,-0.3937, 0.0267}};    // medial posterior condyle</span>
  <span class="n">Points1</span> <span class="o">=</span>
      <span class="gr">{{0.2899, 0.4205, 0.0139},    // fovea capitis</span>
<span class="gr">      {0.3220, 0.4332,-0.3786},    // lateral anterior condyle</span>
<span class="gr">      {0.2893, 0.4268,-0.373},     // medial anterior condyle</span>
<span class="gr">      {0.3289, 0.4259,-0.175},     // anterior mid shaft</span>
<span class="gr">      {0.3063, 0.4872,-0.3703},    // lateral posterior condyle</span>
<span class="gr">      {0.2619, 0.4759,-0.3729}};   // medial posterior condyle</span>
<span class="gr">  Mode = VTK_LANDMARK_AFFINE;</span>
<span class="p">};</span>
</pre></div>
</div>
<p>The selected points on the surface represent specific anatomical
landmarks and points described in the comments of the AnyScript code.
Final modification before we can use the constructed linear transform is
to give this transformation a name and apply it to the source surface:</p>
<div class="highlight-AnyScriptDoc"><div class="highlight"><pre><span></span><span class="kt">AnySeg</span> <span class="n">SourceFemur</span> <span class="o">=</span>
<span class="p">{</span>
  <span class="n">Mass</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">Jii</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">};</span>
  <span class="kt">AnyDrawSurf</span> <span class="n">Surface</span> <span class="o">=</span>
  <span class="p">{</span>
    <span class="n">FileName</span> <span class="o">=</span> <span class="s">&quot;SourceFemur.stl&quot;</span><span class="p">;</span>
    <span class="gr">AnyFunTransform3D &amp;ref = ..MyTransform;</span>
  <span class="p">};</span>
<span class="p">};</span>
</pre></div>
</div>
<p>Reloading the model and looking at the bones shown in the Model View, we
can see that these bones are now merged. To highlight the differences,
we select one of them. This will produce the following picture.</p>
<p><a class="reference internal" href="../_images/image235.png"><img alt="Model view Femur AnyFunTransform3DLin2 final" src="../_images/image235.png" style="width: 6.68750in; height: 2.60417in;" /></a></p>
<p>We can see that the source bone is now scaled, i.e., moved, scaled and
skewed to match the target bone. To make that clear, let us add a new
AnyFunTransform3DLin2 called MyTransform2 to the model which we place
after MyTransform. We want this new transform to perform the rigid-body
registration between target and source surface. Please note, that we
therefore exchange the roles of the sets of source points Points0 and
target points Points1 and set the mode to VTK_LANDMARK_RIGIDBODY.</p>
<p>Additional to that, we also add a collective transform that contains
forward affine and back registration transforms:</p>
<div class="highlight-AnyScriptDoc"><div class="highlight"><pre><span></span><span class="gr">AnyFunTransform3DLin2 MyTransform2 = {</span>
<span class="gr">  Points0 = .MyTransform.Points1;</span>
<span class="gr">  Points1 = .MyTransform.Points0;</span>
<span class="gr">  Mode = VTK_LANDMARK_RIGIDBODY;</span>
<span class="gr">};</span>
<span class="gr">AnyFunTransform3DIdentity MyTransform3 =</span>
<span class="gr">{</span>
<span class="gr">  PreTransforms = {&amp;.MyTransform,&amp;.MyTransform2};</span>
<span class="gr">};</span>
</pre></div>
</div>
<p>Finally, let us look at the effect of the constructed transform. We
comment the transform used in the visualization of the source surface
and create another surface that will show the collective transformation
that we just constructed:</p>
<div class="highlight-AnyScriptDoc"><div class="highlight"><pre><span></span><span class="kt">AnySeg</span> <span class="n">SourceFemur</span> <span class="o">=</span>
<span class="p">{</span>
  <span class="n">Mass</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">Jii</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">};</span>
  <span class="kt">AnyDrawSurf</span> <span class="n">Surface</span> <span class="o">=</span>
  <span class="p">{</span>
    <span class="n">FileName</span> <span class="o">=</span> <span class="s">&quot;SourceFemur.stl&quot;</span><span class="p">;</span>
    <span class="gr">//AnyFunTransform3D &amp;ref = ..MyTransform;</span>
  <span class="p">};</span>
  <span class="gr">AnyDrawSurf SurfaceMorphed =</span>
<span class="gr">  {</span>
<span class="gr">    FileName = &quot;SourceFemur.stl&quot;;</span>
<span class="gr">    AnyFunTransform3D &amp;ref = ..MyTransform3;</span>
<span class="gr">  };</span>
<span class="p">};</span>
</pre></div>
</div>
<p><a class="reference internal" href="../_images/image330.png"><img alt="AnyFunTransform3DLin2 2" src="../_images/image330.png" style="width: 6.68750in; height: 1.68750in;" /></a></p>
<p>Looking at the Model View, we can see that the femur is now scaled, it
became shorter and the alignment match the original source position
well. From the previous picture, we know that geometry is fitting the
target well too (and if you want to convince yourself you can enter the
target geometry too and apply the MyTransform2 to obtain the
registration).</p>
<p>With this example, we have shown how to morph the source into the target
with a full affine scaling and subsequently applying a reverse
registration to move the morphed geometry back.</p>
<p>Notice that it is possible to reverse the combination, i.e., to apply
the registration step first and then the scaling/morphing step. For
instance, make a transformation like MyTransform, but insert
MyTransform2 as pre-transformation. In this tutorial lesson, we shall
however stay with the concept we presented so far.</p>
<p>If the accuracy of the results is sufficient, we could continue working
with this simple morphing. However, this transformation still lacks
desired accuracy as local features, are still not matching the target
shape very well e.g. the lesser and the greater trochanter. The
following lesson explains how to capture more details and construct a
better match.</p>
</div>
<div class="section" id="incorporating-a-landmark-based-non-linearity-into-the-scaling-law">
<h2>Incorporating a landmark-based non-linearity into the scaling law<a class="headerlink" href="#incorporating-a-landmark-based-non-linearity-into-the-scaling-law" title="Permalink to this headline">¶</a></h2>
<p>The next level of detail can be achieved by utilizing a transform using
the AnyFunTransform3DRBF class. This class is using radial basis
functions (RBF) to represent the surface and is constructed by using
source and target landmarks. Detailed behaviour of this transform is
described in an <a class="reference internal" href="lesson3_appendix.html"><span class="doc">appendix tutorial</span></a>. However,
the focus of this tutorial is to demonstrate available pipelines of
transforms. For simplicity, we use a set of femur landmarks and RBF
settings that were tested by the AnyBody team.</p>
<p>We start with the landmark based non-linear scaling by using the model
of the previous steps. We will show how to build up scaling transforms
by including them as pre-transforms and inherit achieved accuracy
throughout different steps. A complete model can you find in
<a class="reference download internal" href="../_downloads/lesson3b.Main.any" download=""><code class="xref download docutils literal"><span class="pre">lesson3b.Main.any</span></code></a>. Let us add an RBF
transform with the recommended settings into the previously created
model.</p>
<p>First of all let us configure the visualization of the transformation.
Now that we know how to compare source and scaled geometries as well as
reverse registration, so we can switch off the registration step.</p>
<div class="highlight-AnyScriptDoc"><div class="highlight"><pre><span></span><span class="kt">AnyFunTransform3DIdentity</span> <span class="n">MyTransform3</span> <span class="o">=</span>
<span class="p">{</span>
  <span class="n">PreTransforms</span> <span class="o">=</span> <span class="p">{</span><span class="o">&amp;</span><span class="p">.</span><span class="n">MyTransform</span><span class="gr">/*,&amp;.MyTransform2*/</span><span class="p">};</span>
<span class="p">};</span>
</pre></div>
</div>
<p>This will return our scaled geometry back to the target bone location
and we can compare the improvements we will create. Let us now define an
RBF scaling law and another AnyDrawSurf object that will show the
difference between the linear scaling law and the new created RBF
scaling law. For a better contrast of the different surfaces, we will
also add some colors to the drawing of the surfaces:</p>
<div class="highlight-AnyScriptDoc"><div class="highlight"><pre><span></span>  <span class="gr">AnyDrawSurf SurfaceMorphedRBF =</span>
<span class="gr">  {</span>
<span class="gr">    FileName = &quot;SourceFemur.stl&quot;;</span>
<span class="gr">    AnyFunTransform3D &amp;ref = ..MyRBFTransform;</span>
<span class="gr">    RGB={1,0,0};</span>
<span class="gr">  };</span>

<span class="p">...</span>

<span class="gr">AnyFunTransform3DRBF MyRBFTransform =</span>
<span class="gr">{</span>
<span class="gr">  PreTransforms = {&amp;.MyTransform};</span>
<span class="gr">  RBFDef =</span>
<span class="gr">  {</span>
<span class="gr">    Type = RBF_ThinPlate;</span>
<span class="gr">    Param = 1;</span>
<span class="gr">  };</span>
<span class="gr">  Points0 = {</span>
<span class="gr">    { 0.0138, 0.0014, 0.0274},</span>
<span class="gr">    { 0.0791,-0.3971,-0.0524},</span>
<span class="gr">    { 0.0940,-0.3954,-0.0183},</span>
<span class="gr">    {-0.0242,-0.0304,-0.0628},</span>
<span class="gr">    { 0.0381,-0.1886,-0.0388},</span>
<span class="gr">    { 0.0188,-0.3965,-0.0205},</span>
<span class="gr">    { 0.0369,-0.3937, 0.0267},</span>
<span class="gr">    {-0.0127, 0.0039, 0.0290},</span>
<span class="gr">    { 0.0188, 0.0092,-0.0153},</span>
<span class="gr">    {-0.0012, 0.0263, 0.0048},</span>
<span class="gr">    {-0.0088,-0.0583, 0.0057},</span>
<span class="gr">    {-0.0311,-0.0214,-0.0227},</span>
<span class="gr">    {-0.0462,-0.0078,-0.0064},</span>
<span class="gr">    {-0.0286,-0.0623,-0.0460},</span>
<span class="gr">    { 0.0010, 0.0013, 0.0069}</span>
<span class="gr">  };</span>
<span class="gr">  PointNames = {</span>
<span class="gr">    &quot;Medial_Head_Point&quot;,</span>
<span class="gr">    &quot;Anterior_LateralCondyle_Point&quot;,</span>
<span class="gr">    &quot;Anterior_MedialCondyle_Point&quot;,</span>
<span class="gr">    &quot;Anterior_GreaterTrochanter_Point&quot;,</span>
<span class="gr">    &quot;Anterior_Shaft_Point&quot;,</span>
<span class="gr">    &quot;Posterior_LateralCondyle_Point&quot;,</span>
<span class="gr">    &quot;Posterior_MedialCondyle_Point&quot;,</span>
<span class="gr">    &quot;Posterior_Head_Point&quot;,</span>
<span class="gr">    &quot;Anterior_Head_Point&quot;,</span>
<span class="gr">    &quot;Proximal_Head_Point&quot;,</span>
<span class="gr">    &quot;Medial_LesserTrochanter_Point&quot;,</span>
<span class="gr">    &quot;Distal_TrochantericFossa_Point&quot;,</span>
<span class="gr">    &quot;Proximal_Posterior_GreaterTrochanter_Point&quot;,</span>
<span class="gr">    &quot;Lateral_Lesser_Trochanter_Point&quot;,</span>
<span class="gr">    &quot;Femoral_COR&quot;</span>
<span class="gr">  };</span>

<span class="gr">  Points1 = {</span>
<span class="gr">    { 0.2900, 0.4205, 0.0139},</span>
<span class="gr">    { 0.3220, 0.4332,-0.3786},</span>
<span class="gr">    { 0.2893, 0.4268,-0.3730},</span>
<span class="gr">    { 0.3599, 0.4429,-0.0050},</span>
<span class="gr">    { 0.3289, 0.4259,-0.1750},</span>
<span class="gr">    { 0.3062, 0.4872,-0.3703},</span>
<span class="gr">    { 0.2619, 0.4759,-0.3727},</span>
<span class="gr">    { 0.2900, 0.4405, 0.0139},</span>
<span class="gr">    { 0.3200, 0.4095, 0.0134},</span>
<span class="gr">    { 0.3100, 0.4295, 0.0314},</span>
<span class="gr">    { 0.3089, 0.4599,-0.0355},</span>
<span class="gr">    { 0.3349, 0.4579, 0.0050},</span>
<span class="gr">    { 0.3329, 0.4679, 0.0175},</span>
<span class="gr">    { 0.3519, 0.4599,-0.0355},</span>
<span class="gr">    { 0.3075, 0.4235, 0.0139}</span>
<span class="gr">  };</span>
<span class="gr">  BoundingBox =</span>
<span class="gr">  {</span>
<span class="gr">    Type = BB_Cartesian;</span>
<span class="gr">    ScaleXYZ = {2, 2, 2};</span>
<span class="gr">    DivisionFactorXYZ = 5*{1, 1, 1};</span>
<span class="gr">  };</span>
<span class="gr">  BoundingBoxOnOff = On;</span>
<span class="gr">};</span>
</pre></div>
</div>
<p><a class="reference internal" href="../_images/image422.png"><img alt="Model view Femur AnyFunTransform3DRBF 2" src="../_images/image422.png" style="width: 6.67708in; height: 1.93750in;" /></a></p>
<p>The suggested transform morphs the source geometry in a thin-plate
manner and tries to minimize the distance between the selected key
points (landmarks). This can be useful if certain muscle attachment
areas/points need to be scaled. Using this transform will make it
possible to improve the model by morphing some local features that are
important for the analysis. Please note that MyTransform object was
included as a pre-transform as a rough scaling preceding the non-linear
RBF function, and, therefore, the outcome of this transformation, our
previous result, can be considered the first object in the transform
pipeline. Target bone is color-coded with the green color, initial
linear scaling is grey, RBF-scaled bone is red.</p>
<p>However, there is still some possibility to improve the fitting of the
femur surfaces into each other and possibly improve the model. Looking
at the Model View you can notice that the greater trochanter is elevated
and makes a sharp corner – this is due to the thin-plate nature of the
transform and a low number of control points. The following section will
describe how to utilize surface information for the construction of an
improved scaling law.</p>
</div>
<div class="section" id="incorporating-a-surface-based-non-linearity-into-the-scaling-law">
<h2>Incorporating a surface based non-linearity into the scaling law<a class="headerlink" href="#incorporating-a-surface-based-non-linearity-into-the-scaling-law" title="Permalink to this headline">¶</a></h2>
<p>In this section, we see how the scaling law can be improved by utilizing
two surfaces and requesting them to fit each other, which will also
deform all related muscle and ligament attachment points accordingly. We
use the AnyFunTransform3DSTL class for this purpose. This class
constructs an RBF transform by using either corresponding vertices on
the STL surfaces or seeding a number of vertices on one surface and
finding a matching closest point on the second. For constructing a
transformation using the vertices of STL surfaces, the surfaces have to
be topologically equivalent, i.e. the surfaces have the same number of
triangles and each neighbor and vertices are the same on both surfaces.
For the latter option, we require a pretty good pre-registration
transform, e.g. the RBF transform that was described previously, in
order for the closest point finding to make sense. Due to the
implementation specifics most of the RBF recommendations apply to this
class as well. More details about how to create this kind of transforms
are described in the <a class="reference internal" href="lesson3_appendix.html"><span class="doc">appendix
tutorial</span></a>. However, for this example the
recommended settings mentioned before will be used again.</p>
<p>Let us repeat the step from the previous section by adding one more
surface to the visualization and another scaling step. You can download
the model with all modifications <a class="reference download internal" href="../_downloads/lesson3c.Main.any" download=""><code class="xref download docutils literal"><span class="pre">here</span></code></a>:</p>
<div class="highlight-AnyScriptDoc"><div class="highlight"><pre><span></span>  <span class="gr">AnyDrawSurf SurfaceMorphedSTL =</span>
<span class="gr">  {</span>
<span class="gr">    FileName = &quot;SourceFemur.stl&quot;;</span>
<span class="gr">    AnyFunTransform3D &amp;ref = ..MySTLTransform;</span>
<span class="gr">    RGB={0,0,1};</span>
<span class="gr">  };</span>

<span class="p">...</span>
<span class="gr">    AnyFunTransform3DSTL MySTLTransform =</span>
<span class="gr">{</span>
<span class="gr">  PreTransforms = {&amp;.MyRBFTransform};</span>
<span class="gr">  RBFDef.Type = RBF_ThinPlate;</span>
<span class="gr">  AnyFixedRefFrame Input = {</span>
<span class="gr">    AnySurfSTL SourceSurf = {</span>
<span class="gr">      FileName = &quot;SourceFemur.stl&quot;;</span>
<span class="gr">      ScaleXYZ = {1, 1, 1};</span>
<span class="gr">    };</span>
<span class="gr">    AnySurfSTL TargetSurf = {</span>
<span class="gr">      FileName = &quot;TargetFemur.stl&quot;;</span>
<span class="gr">      ScaleXYZ = {1, 1, 1};</span>
<span class="gr">    };</span>
<span class="gr">  };</span>

<span class="gr">  SurfaceObjects0 = {&amp;Input.SourceSurf};</span>
<span class="gr">  SurfaceObjects1 = {&amp;Input.TargetSurf};</span>
<span class="gr">  //FileName0 = &quot;SourceFemur.stl&quot;;    // such definition was used previously</span>
<span class="gr">  //FileName1 = &quot;TargetFemur.stl&quot;;    // such definition was used previously</span>
<span class="gr">  NumPoints = 400;</span>
<span class="gr">  BoundingBox.ScaleXYZ = {2, 2, 2};</span>
<span class="gr">  BoundingBox.DivisionFactorXYZ = {1, 1, 1};</span>
<span class="gr">  BoundingBoxOnOff = On;</span>
<span class="gr">};</span>
</pre></div>
</div>
<p><a class="reference internal" href="../_images/image520.png"><img alt="image4" src="../_images/image520.png" style="width: 6.68750in; height: 1.97917in;" /></a></p>
<p>Please note again the transform from the previous section of this
tutorial was included as a pre-transform. Reloading the model, we can
now see all steps of scaling in one place and try to switch them on and
off. For example, let us try to hide affine and RBF scaled femurs to see
the final results:</p>
<p><a class="reference internal" href="../_images/image612.png"><img alt="Model view Femur AnyFunTransform3DRBF final" src="../_images/image612.png" style="width: 6.68750in; height: 1.92708in;" /></a></p>
<p>If we just look at the green target surface and the blue STL-transformed
surface, we can see that the surfaces now match each other very well. That means
that now the subject-specificity will be taken into account in the inverse
dynamics simulation. The final model can be downloaded <a class="reference download internal" href="../_downloads/lesson3d.Main.any" download=""><code class="xref download docutils literal"><span class="pre">here</span></code></a>.</p>
<div class="toctree-wrapper compound">
</div>
<p>Finally, the only thing left is to include this scaling law into an
actual model. <a class="reference internal" href="lesson4.html"><span class="doc">Lesson 4</span></a> describes how this can be
done.</p>
<div class="without-title admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last"><strong>Next lesson:</strong> <a class="reference internal" href="lesson4.html"><span class="doc">Lesson 4: Including a Custom Scaling Law</span></a>.</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
        <p class="logo"><a href="../index.html" title="index">
          <img class="logo" src="../_static/anybody_tutorials_logo.png" alt="Logo"/>
        </a></p>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
<div class="sphinx-toc sphinxglobaltoc">
<h3><a href="../contents.html">Table Of Contents</a></h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../index.html">Tutorial overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../A_Getting_started/index.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../A_Getting_started_anyscript/index.html">Getting started: AnyScript Programming</a></li>
<li class="toctree-l1"><a class="reference internal" href="../A_Getting_started_modeling/index.html">Getting Started with Modeling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Interface_features/index.html">User interface features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../A_study_of_studies/index.html">A Study of Studies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Making_things_move/index.html">Making things move</a></li>
<li class="toctree-l1"><a class="reference internal" href="../MuscleRecruitment/index.html">Inverse Dynamics of Muscle Systems</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ForceDependentKinematics/index.html">Force-Dependent Kinematics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Muscle_modeling/index.html">Muscle Modeling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../The_mechanical_elements/index.html">The Mechanical Elements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Advanced_script_features/index.html">Advanced Script Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Finite_element_analysis/index.html">Finite Element Analysis Interfacing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../AnyExp4SOLIDWORKS/index.html">Making Models using SOLIDWORKS</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Scaling</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="intro.html">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="lesson1.html">Lesson 1: Joint to Joint Scaling Methods</a></li>
<li class="toctree-l2"><a class="reference internal" href="lesson2.html">Lesson 2: Scaling based on External Body Measurements</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Lesson 3: Scaling individual segments based on subject-specific data from medical images</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#linear-point-based-scaling">Linear point-based scaling</a></li>
<li class="toctree-l3"><a class="reference internal" href="#incorporating-a-landmark-based-non-linearity-into-the-scaling-law">Incorporating a landmark-based non-linearity into the scaling law</a></li>
<li class="toctree-l3"><a class="reference internal" href="#incorporating-a-surface-based-non-linearity-into-the-scaling-law">Incorporating a surface based non-linearity into the scaling law</a><ul>
<li class="toctree-l4"><a class="reference internal" href="lesson3_appendix.html"> Lesson 3 appendix</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="lesson4.html">Lesson 4: Including a Custom Scaling Law</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../Validation_of_models/index.html">Validation of Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Parameter_studies_and_optimization/index.html">Parameter Studies and Optimization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Troubleshooting_anyscript/intro.html">Trouble Shooting AnyScript Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Posture_and_movement/intro.html">Posture and Movement Prediction</a></li>
</ul>
</div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/Scaling/lesson3.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
        </div>
      </div>
    
    
        <div class="sidebar-toggle-group no-js">
            
            <button class="sidebar-toggle" id="sidebar-hide" title="Hide the sidebar menu">
                 «
                <span class="show-for-small">hide menu</span>
                
            </button>
            <button class="sidebar-toggle" id="sidebar-show" title="Show the sidebar menu">
                
                <span class="show-for-small">menu</span>
                <span class="hide-for-small">sidebar</span>
                 »
            </button>
        </div>
    
      <div class="clearer"></div>
    </div>
    <div class="relbar-bottom">
        
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../contents.html" title="Table Of Contents"
             >toc</a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="lesson3_appendix.html" title="Appendix: Scaling based on Patient-Specific Landmarks"
             >next</a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="lesson2.html" title="Lesson 2: Scaling based on External Body Measurements"
             >previous</a> &nbsp; &nbsp;</li>
    <li><a href="../index.html">AnyBody Tutorials v7.0.1 Documentation</a> &#187;</li>

          <li class="nav-item nav-item-1"><a href="index.html" >Scaling</a> &#187;</li> 
      </ul>
    </div>
    </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2017, AnyBody Technology.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.6.5.
    </div>
    <!-- cloud_sptheme 1.4 -->
  </body>
</html>